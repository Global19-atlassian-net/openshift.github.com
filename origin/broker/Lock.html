<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Lock
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (L)</a> &raquo;
    
    
    <span class="title">Lock</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Lock
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Lock</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Mongoid::Document</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">origin-server/controller/app/models/lock.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
Represents a lock object for a <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> and <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that it owns
</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#apps-instance_method" title="#apps (instance method)">- (Object) <strong>apps</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked-instance_method" title="#locked (instance method)">- (Boolean) <strong>locked</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Repesenting if the user is locked.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#user-instance_method" title="#user (instance method)">- (CloudUser) <strong>user</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Owner of the lock.
</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_lock-class_method" title="create_lock (class method)">+ (Object) <strong>create_lock</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete_lock-class_method" title="delete_lock (class method)">+ (Object) <strong>delete_lock</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock_application-class_method" title="lock_application (class method)">+ (Object) <strong>lock_application</strong>(application, timeout = 600) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Attempts to lock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock_user-class_method" title="lock_user (class method)">+ (Object) <strong>lock_user</strong>(user, app, timeout = 600) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock_application-class_method" title="unlock_application (class method)">+ (Object) <strong>unlock_application</strong>(application) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Attempts to unlock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock_user-class_method" title="unlock_user (class method)">+ (Object) <strong>unlock_user</strong>(user, app) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Attempts to unlock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.
</p>
</div></span>
  
</li>

      
    </ul>
  


  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="apps-instance_method">
  
    - (<tt>Object</tt>) <strong>apps</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'><p>
List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 8</span>

<span class='rubyid_class class kw'>class</span> <span class='rubyid_Lock constant id'>Lock</span>
  <span class='rubyid_include identifier id'>include</span> <span class='rubyid_Mongoid constant id'>Mongoid</span><span class='colon2 op'>::</span><span class='rubyid_Document constant id'>Document</span>
  
  <span class='rubyid_belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:user</span><span class='comma token'>,</span> <span class='rubyid_class_name identifier id'>class_name</span><span class='colon op'>:</span> <span class='rubyid_CloudUser constant id'>CloudUser</span><span class='dot token'>.</span><span class='rubyid_name identifier id'>name</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:locked</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Boolean constant id'>Boolean</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:timeout</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Integer constant id'>Integer</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='integer val'>0</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:app_ids</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Hash constant id'>Hash</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    
  <span class='rubyid_index identifier id'>index</span><span class='lparen token'>(</span><span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>1</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='rubyid_create_indexes identifier id'>create_indexes</span>

  <span class='comment val'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.</span>
  <span class='comment val'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_create_lock identifier id'>create_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_delete_lock identifier id'>delete_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
 
  <span class='comment val'># Attempts to lock the {CloudUser}. </span>
  <span class='comment val'># NOTE: User lock is available only for user apps with application lock.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_user identifier id'>lock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='symbol val'>:timeout</span><span class='dot token'>.</span><span class='rubyid_lt identifier id'>lt</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='rubyid_locked identifier id'>locked</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='colon op'>:</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock the {CloudUser}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_user identifier id'>unlock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;locked&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.</span>
  <span class='comment val'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_application identifier id'>lock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>
      
      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$lt&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to obtain lock for application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock an {Application}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_application identifier id'>unlock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$unset&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;&quot;</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to unlock application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="locked-instance_method">
  
    - (<tt>Boolean</tt>) <strong>locked</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Repesenting if the user is locked
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>
repesenting if the user is locked
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 8</span>

<span class='rubyid_class class kw'>class</span> <span class='rubyid_Lock constant id'>Lock</span>
  <span class='rubyid_include identifier id'>include</span> <span class='rubyid_Mongoid constant id'>Mongoid</span><span class='colon2 op'>::</span><span class='rubyid_Document constant id'>Document</span>
  
  <span class='rubyid_belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:user</span><span class='comma token'>,</span> <span class='rubyid_class_name identifier id'>class_name</span><span class='colon op'>:</span> <span class='rubyid_CloudUser constant id'>CloudUser</span><span class='dot token'>.</span><span class='rubyid_name identifier id'>name</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:locked</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Boolean constant id'>Boolean</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:timeout</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Integer constant id'>Integer</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='integer val'>0</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:app_ids</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Hash constant id'>Hash</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    
  <span class='rubyid_index identifier id'>index</span><span class='lparen token'>(</span><span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>1</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='rubyid_create_indexes identifier id'>create_indexes</span>

  <span class='comment val'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.</span>
  <span class='comment val'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_create_lock identifier id'>create_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_delete_lock identifier id'>delete_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
 
  <span class='comment val'># Attempts to lock the {CloudUser}. </span>
  <span class='comment val'># NOTE: User lock is available only for user apps with application lock.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_user identifier id'>lock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='symbol val'>:timeout</span><span class='dot token'>.</span><span class='rubyid_lt identifier id'>lt</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='rubyid_locked identifier id'>locked</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='colon op'>:</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock the {CloudUser}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_user identifier id'>unlock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;locked&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.</span>
  <span class='comment val'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_application identifier id'>lock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>
      
      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$lt&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to obtain lock for application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock an {Application}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_application identifier id'>unlock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$unset&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;&quot;</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to unlock application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="user-instance_method">
  
    - (<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>) <strong>user</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Owner of the lock
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>
owner of the lock
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 8</span>

<span class='rubyid_class class kw'>class</span> <span class='rubyid_Lock constant id'>Lock</span>
  <span class='rubyid_include identifier id'>include</span> <span class='rubyid_Mongoid constant id'>Mongoid</span><span class='colon2 op'>::</span><span class='rubyid_Document constant id'>Document</span>
  
  <span class='rubyid_belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:user</span><span class='comma token'>,</span> <span class='rubyid_class_name identifier id'>class_name</span><span class='colon op'>:</span> <span class='rubyid_CloudUser constant id'>CloudUser</span><span class='dot token'>.</span><span class='rubyid_name identifier id'>name</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:locked</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Boolean constant id'>Boolean</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:timeout</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Integer constant id'>Integer</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='integer val'>0</span>
  <span class='rubyid_field identifier id'>field</span> <span class='symbol val'>:app_ids</span><span class='comma token'>,</span> <span class='rubyid_type identifier id'>type</span><span class='colon op'>:</span> <span class='rubyid_Hash constant id'>Hash</span><span class='comma token'>,</span> <span class='rubyid_default identifier id'>default</span><span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    
  <span class='rubyid_index identifier id'>index</span><span class='lparen token'>(</span><span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>1</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='rubyid_create_indexes identifier id'>create_indexes</span>

  <span class='comment val'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.</span>
  <span class='comment val'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_create_lock identifier id'>create_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_delete_lock identifier id'>delete_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
  <span class='rubyid_end end kw'>end</span>
 
  <span class='comment val'># Attempts to lock the {CloudUser}. </span>
  <span class='comment val'># NOTE: User lock is available only for user apps with application lock.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_user identifier id'>lock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='symbol val'>:timeout</span><span class='dot token'>.</span><span class='rubyid_lt identifier id'>lt</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='rubyid_locked identifier id'>locked</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='colon op'>:</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock the {CloudUser}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># user::</span>
  <span class='comment val'>#   The {CloudUser} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_user identifier id'>unlock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;locked&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.</span>
  <span class='comment val'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to lock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the lock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_application identifier id'>lock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>
      
      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$lt&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to obtain lock for application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
  
  <span class='comment val'># Attempts to unlock an {Application}.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Parameters:</span>
  <span class='comment val'># application::</span>
  <span class='comment val'>#   The {Application} to attempt to unlock</span>
  <span class='comment val'>#</span>
  <span class='comment val'># == Returns:</span>
  <span class='comment val'># True if the unlock was successful.</span>
  <span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_application identifier id'>unlock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='rparen token'>)</span>
    <span class='rubyid_begin begin kw'>begin</span>
      <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
      <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
      <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
      <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
      <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_else else kw'>else</span>
        <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
      <span class='rubyid_end end kw'>end</span>

      <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
      <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$unset&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;&quot;</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span>
      <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
      <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
    <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
      <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to unlock application #{application.name}: #{ex.message}&quot;</span>
      <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
    <span class='rubyid_end end kw'>end</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="create_lock-class_method">
  
    + (<tt>Object</tt>) <strong>create_lock</strong>(user) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>. Once locked, no other threads can obtain
a lock on the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> or any owned <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s. This lock is denied
if any of the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s owned by the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> are currently locked.
</p>
<h2>Parameters:</h2>
<table>
<tr><td valign="top">user:</td><td>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> to attempt to lock

</td></tr>
</table>
<h2>Returns:</h2>
<p>
True if the lock was successful.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 29</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_create_lock identifier id'>create_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
  <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="delete_lock-class_method">
  
    + (<tt>Object</tt>) <strong>delete_lock</strong>(user) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 33</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_delete_lock identifier id'>delete_lock</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='rparen token'>)</span>
  <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_delete identifier id'>delete</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_application-class_method">
  
    + (<tt>Object</tt>) <strong>lock_application</strong>(application, timeout = 600) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Attempts to lock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>. Once locked, no other threads can obtain
a lock on the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> or the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> that owns it. This lock is
denied if the owning <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> is locked or the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> has been
locked by another thread.
</p>
<h2>Parameters:</h2>
<table>
<tr><td valign="top">application:</td><td>The <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> to attempt to lock

</td></tr>
</table>
<h2>Returns:</h2>
<p>
True if the lock was successful.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 80</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_application identifier id'>lock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
  <span class='rubyid_begin begin kw'>begin</span>
    <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
    <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
    <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
    <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
      <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
    <span class='rubyid_end end kw'>end</span>
    
    <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
    <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
    <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$lt&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
    <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
  <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
    <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to obtain lock for application #{application.name}: #{ex.message}&quot;</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_user-class_method">
  
    + (<tt>Object</tt>) <strong>lock_user</strong>(user, app, timeout = 600) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>. NOTE: User lock is available only for
user apps with application lock.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41
42
43
44
45
46
47
48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 39</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_lock_user identifier id'>lock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='assign token'>=</span><span class='integer val'>600</span><span class='rparen token'>)</span>
  <span class='rubyid_begin begin kw'>begin</span>
    <span class='rubyid_now identifier id'>now</span> <span class='assign token'>=</span> <span class='rubyid_Time constant id'>Time</span><span class='dot token'>.</span><span class='rubyid_now identifier id'>now</span><span class='dot token'>.</span><span class='rubyid_to_i identifier id'>to_i</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_or_create_by identifier id'>find_or_create_by</span><span class='lparen token'>(</span> <span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span> <span class='rparen token'>)</span>
    <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='string val'>&quot;$or&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='lbrace token'>{</span><span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='symbol val'>:timeout</span><span class='dot token'>.</span><span class='rubyid_lt identifier id'>lt</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='rubyid_locked identifier id'>locked</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='colon op'>:</span> <span class='lparen token'>(</span><span class='rubyid_now identifier id'>now</span> <span class='plus op'>+</span> <span class='rubyid_timeout identifier id'>timeout</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
  <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock_application-class_method">
  
    + (<tt>Object</tt>) <strong>unlock_application</strong>(application) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Attempts to unlock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.
</p>
<h2>Parameters:</h2>
<table>
<tr><td valign="top">application:</td><td>The <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> to attempt to unlock

</td></tr>
</table>
<h2>Returns:</h2>
<p>
True if the unlock was successful.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 112</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_application identifier id'>unlock_application</span><span class='lparen token'>(</span><span class='rubyid_application identifier id'>application</span><span class='rparen token'>)</span>
  <span class='rubyid_begin begin kw'>begin</span>
    <span class='comment val'># application.domain can be nil if the application is being created immediately after domain creation</span>
    <span class='comment val'># If the domain is being read from the secondary, it may not be present</span>
    <span class='comment val'># If domain is nil, try to load the domain from the primary</span>
    <span class='comment val'># Note: If there is a way to load the domain relationship from the primary, we should do that </span>
    <span class='rubyid_if if kw'>if</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span>
      <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_Domain constant id'>Domain</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_by identifier id'>find_by</span><span class='lparen token'>(</span><span class='rubyid__id identifier id'>_id</span><span class='colon op'>:</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain_id identifier id'>domain_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
    <span class='rubyid_else else kw'>else</span>
      <span class='rubyid_user_id identifier id'>user_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid_domain identifier id'>domain</span><span class='dot token'>.</span><span class='rubyid_owner_id identifier id'>owner_id</span>
    <span class='rubyid_end end kw'>end</span>

    <span class='rubyid_app_id identifier id'>app_id</span> <span class='assign token'>=</span> <span class='rubyid_application identifier id'>application</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='dot token'>.</span><span class='rubyid_to_s identifier id'>to_s</span>
    <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user_id identifier id'>user_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$unset&quot;</span><span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='dstring node'>&quot;app_ids.#{app_id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;&quot;</span><span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
  <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_ex identifier id'>ex</span>
    <span class='rubyid_Rails constant id'>Rails</span><span class='dot token'>.</span><span class='rubyid_logger identifier id'>logger</span><span class='dot token'>.</span><span class='rubyid_error identifier id'>error</span> <span class='dstring node'>&quot;Failed to unlock application #{application.name}: #{ex.message}&quot;</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock_user-class_method">
  
    + (<tt>Object</tt>) <strong>unlock_user</strong>(user, app) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>
Attempts to unlock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.
</p>
<h2>Parameters:</h2>
<table>
<tr><td valign="top">user:</td><td>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> to attempt to unlock

</td></tr>
</table>
<h2>Returns:</h2>
<p>
True if the unlock was successful.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'origin-server/controller/app/models/lock.rb', line 60</span>

<span class='rubyid_def def kw'>def</span> <span class='rubyid_self self kw'>self</span><span class='dot token'>.</span><span class='rubyid_unlock_user identifier id'>unlock_user</span><span class='lparen token'>(</span><span class='rubyid_user identifier id'>user</span><span class='comma token'>,</span> <span class='rubyid_app identifier id'>app</span><span class='rparen token'>)</span>
  <span class='rubyid_begin begin kw'>begin</span>
    <span class='rubyid_query identifier id'>query</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_user identifier id'>user</span><span class='dot token'>.</span><span class='rubyid__id identifier id'>_id</span><span class='comma token'>,</span> <span class='symbol val'>:locked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span><span class='comma token'>,</span> <span class='dstring node'>&quot;app_ids.#{app._id}&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;$exists&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_updates identifier id'>updates</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='string val'>&quot;$set&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;locked&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_false false kw'>false</span> <span class='rbrace token'>}</span><span class='rbrace token'>}</span>
    <span class='rubyid_lock identifier id'>lock</span> <span class='assign token'>=</span> <span class='rubyid_Lock constant id'>Lock</span><span class='dot token'>.</span><span class='rubyid_with identifier id'>with</span><span class='lparen token'>(</span><span class='rubyid_consistency identifier id'>consistency</span><span class='colon op'>:</span> <span class='symbol val'>:strong</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_where identifier id'>where</span><span class='lparen token'>(</span><span class='rubyid_query identifier id'>query</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='rubyid_find_and_modify identifier id'>find_and_modify</span><span class='lparen token'>(</span><span class='rubyid_updates identifier id'>updates</span><span class='comma token'>,</span> <span class='rubyid_new identifier id'>new</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span><span class='rparen token'>)</span>
    <span class='rubyid_return return kw'>return</span> <span class='lparen token'>(</span><span class='rubyid_not not kw'>not</span> <span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span><span class='rubyid_nil? fid id'>nil?</span><span class='rparen token'>)</span>
  <span class='rubyid_rescue rescue kw'>rescue</span> <span class='rubyid_Moped constant id'>Moped</span><span class='colon2 op'>::</span><span class='rubyid_Errors constant id'>Errors</span><span class='colon2 op'>::</span><span class='rubyid_OperationFailure constant id'>OperationFailure</span>
    <span class='rubyid_return return kw'>return</span> <span class='rubyid_false false kw'>false</span>
  <span class='rubyid_end end kw'>end</span>
<span class='rubyid_end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sat Apr 27 18:24:52 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-1.8.7).
</div>

  </body>
</html>