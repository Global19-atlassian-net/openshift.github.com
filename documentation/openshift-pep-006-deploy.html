<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="Asciidoctor 0.1.4" name="generator">
<meta content="OpenShift Origin Documentation Project &lt;dev@lists.openshift.redhat.com&gt;" name="author">
<title>OpenShift PEP 006: Zero downtime for scaled applications during deployment and restarts</title>
<style>@import url(http://openshift.redhat.com/app/assets/overpass.css);
@import url(http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/*
Origin theme source file

To build it:
- clone the asciidoctor-stylesheet-factory repo
- copy this theme file to the sass folder inside the repo
- copy the settings file to the sass/settings file inside the repo
- cd to the cloned repo
- bundle install
- compass compile
- compiled stylesheet is in the stylesheets/ directory
*/
/* Generated by Font Squirrel (http://www.fontsquirrel.com) on July 24, 2013 */
@font-face { font-family: 'source_code_pro'; src: url("fonts/sourcecodepro-regular-webfont.eot"); src: url("fonts/sourcecodepro-regular-webfont.eot?#iefix") format("embedded-opentype"), url("fonts/sourcecodepro-regular-webfont.woff") format("woff"), url("fonts/sourcecodepro-regular-webfont.ttf") format("truetype"), url("sourcecodepro-regular-webfont.svg#source_code_proregular") format("svg"); font-weight: normal; font-style: normal; }

/*
Settings and overrides for the Origin theme
*/
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title, .tableblock > caption { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #006699; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #005580; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Overpass, sans-serif; font-weight: bold; font-style: normal; color: #222222; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #7f0a0c; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

/*
.clearfix,
.floatend { zoom: 1; &:before, &:after { content: " "; display: table; } &:after { clear: both; }
}
*/
code { font-size: inherit; padding: 0; white-space: nowrap; background-color: inherit; border: 0 solid #dddddd; -webkit-border-radius: 0; border-radius: 0; text-shadow: none; }

kbd.keyseq { color: #555555; }

kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: #222222; font-weight: bold; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.25em; }
#toc > ul, #toc > ol { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a, #toc ol.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1, #toc ol.sectlevel0 ol.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul, #toc ol { list-style-type: none; }

#toctitle { color: #6f6f6f; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul, #toc.toc2 > ol { font-size: .95em; }
  #toc.toc2 ul ul, #toc.toc2 ol ol { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1, #toc.toc2 ol.sectlevel0 ol.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > .paragraph:last-child > p { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; line-height: 1.6; }
.sidebarblock > .content > .paragraph:last-child p { margin-bottom: 0; }

pre { color: black; font-family: source_code_pro, monospace, serif; overflow-x: auto; line-height: 1.4; }

.verseblock { margin-bottom: 1.25em; }

.literalblock, .listingblock { margin-bottom: 1.25em; }
.literalblock > .content > pre, .listingblock > .content > pre { background: #eeeeee; color: black; font-family: source_code_pro, monospace, serif; border-width: 0; padding: 0.8em 0.8em 0.6em 0.8em; word-wrap: break-word; line-height: 1.4; }
.literalblock > .content > pre.nowrap, .listingblock > .content > pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content > pre > code, .listingblock > .content > pre > code { font-size: 1em; white-space: inherit; color: black; font-family: source_code_pro, monospace, serif; padding: 0; background: none; font-weight: normal; border: none; }
@media only screen { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 1em; } }

.listingblock:hover .xml:before { content: "xml"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .html:before { content: "html"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .ruby:before { content: "ruby"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .asciidoc:before { content: "asciidoc"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .java:before { content: "java"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .javascript:before { content: "javascript"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .css:before { content: "css"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .scss:before { content: "scss"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }

.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 0; border-radius: 0; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.halign-top, td.tableblock.halign-top { vertical-align: top; }

th.tableblock.halign-bottom, td.tableblock.halign-bottom { vertical-align: bottom; }

th.tableblock.halign-middle, td.tableblock.halign-middle { vertical-align: middle; }

p.tableblock.header { color: #222222; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist { list-style-type: none; margin-left: 0.625em; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

td.hdlist1 { vertical-align: top; padding-right: .8em; font-weight: bold; }

.qanda > ol > li > p:first-child { color: #005580; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: none; box-shadow: none; }

.imageblock { margin-bottom: 1.25em; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding: 0.75em 0.375em; margin-bottom: 1.25em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: none; cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #006699; color: #004c73; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

nav.global { background: #222; width: 100%; height: 4em; }
nav.global ul { list-style-type: none; margin: 0; }
nav.global li { display: inline-block; }
nav.global a { display: block; padding: .5em 1em; font-family: Overpass; font-size: 1.1em; color: white; }
nav.global a:hover { color: #ef2e32; }
nav.global a img { margin-top: .25em; height: 2.75em; }

#header > h1 { border: none; }

#toc { background: #eee; border-right: none; }
#toc.toc2 { box-shadow: 1px 0 1px rgba(0, 0, 0, 0.3); }

code { font-family: source_code_pro; }

.admonitionblock td.icon .icon-tip:before { color: #cc6; text-shadow: none; }

#footer { background-image: url("images/panda.png"); background-position: right bottom; background-repeat: no-repeat; }

/* Alignment Styles */
.halign-left { text-align: left }
.halign-center { text-align: center }
.halign-right { text-align: right }

.valign-top { vertical-align: top }
.valign-middle { vertical-align: middle }
.valign-bottom { vertical-align: bottom }</style>
<link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="article toc2">
<nav class="global">
<ul>
<li>
<a href="http://openshift.github.io">
<img alt="OpenShift Origin" src="images/logo.png">
</a>
</li>
<li>
<a href="index.html">Documentation Home</a>
</li>
</ul>
</nav>
<div id="header">
<h1>OpenShift PEP 006: Zero downtime for scaled applications during deployment and restarts</h1>
<span id="author">OpenShift Origin Documentation Project &lt;dev@lists.openshift.redhat.com&gt;</span>
<br>
<div class="toc2" id="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#specification">Specification</a></li>
<li><a href="#backwards-compatibility">Backwards Compatibility</a></li>
</ul>
</div>
</div>
<div id="content"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>PEP: 006<br>
Title: Zero downtime for scaled applications during deployment and restarts<br>
Status: accepted<br>
Author: Andy Goldstein <a href="mailto:agoldste@redhat.com">agoldste@redhat.com</a>, Dan McPherson <a href="mailto:dmcphers@redhat.com">dmcphers@redhat.com</a>, Clayton Coleman <a href="mailto:ccoleman@redhat.com">ccoleman@redhat.com</a><br>
Arch Priority: TBD<br>
Complexity: 40 - 100<br>
Affected Components: web, api, runtime, broker, cli<br>
Affected Teams: Runtime (40), UI (20), Broker (8), Enterprise (5)<br>
User Impact: medium Epic: E05 <a href="https://trello.com/c/krgSeomK">https://trello.com/c/krgSeomK</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="abstract"><a class="anchor" href="#abstract"></a>Abstract</h3>
<div class="paragraph">
<p>Today in OpenShift, when a user pushes an update to an application, the application is taken offline temporarily during the deployment of the new code. This means incoming requests may fail for a short period of time. With some improvements to the application lifecycle, OpenShift users should be able to push updates or restart their scaled applications with zero downtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="motivation"><a class="anchor" href="#motivation"></a>Motivation</h3>
<div class="paragraph">
<p>Uptime and availability are key considerations for application providers when choosing a deployment platform and environment. Users attempting to access an application running in OpenShift will possibly experience an outage when that application is in the middle of a deployment, which is undesirable.</p>
</div>
<div class="paragraph">
<p>The goal of this PEP is to improve the operational experience of managing applications in OpenShift. It will include features such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>zero downtime during a deployment or restart</p>
</li>
<li>
<p>rolling deployments/restarts</p>
</li>
<li>
<p>graceful shutdown of gears (drain will be in conjunction with the HA pep)</p>
</li>
<li>
<p>First pass won&#8217;t include modcluster for jboss</p>
</li>
<li>
<p>ability to roll back a deployment to a previous version</p>
</li>
<li>
<p>ability to push code now but build and deploy it later</p>
</li>
<li>
<p>ability to implement a custom build process by re-composing operations that make up the platform build process</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="specification"><a class="anchor" href="#specification"></a>Specification</h3>
<div class="paragraph">
<p>OpenShift must allow efficient, scalable, and controllable builds and deployments, with the ability to extend portions of the workflow.</p>
</div>
<div class="paragraph">
<p>A <strong>build</strong> is a process that converts source code into a <strong>build result</strong>. A build result is eventually <strong>prepared</strong> for deployment, <strong>distributed</strong> to some or all of an application&#8217;s gears, and finally <strong>activated</strong> on those gears. The prepare/distribute/activate deployment lifecycle may happen immediately as part of the familiar workflow wherein <code>git push</code> builds the application and deploys it. Alternatively, a user may disable automatic deployments and choose instead to deploy in the future via new methods described below.</p>
</div>
<div class="paragraph">
<p>Build results may be created either inside or outside of OpenShift. Build results created inside OpenShift are created via <code>git push</code> and are managed by the platform and/or build cartridges (i.e. Jenkins). Build results created outside of OpenShift must conform to a specific format, and are used as inputs when using the new binary deployment feature. A build result must include the application code and/or anything produced by the application&#8217;s build process (e.g. a .war file). It is essentially the state of the app-root/runtime/repo and app-root/runtime/dependencies on the gear after a "build" has been executed (mvn/rake/npm/etc)</p>
</div>
<div class="paragraph">
<p>Preparing a build result for deployment involves the execution of a <code>prepare</code> platform action and a user-defined <code>prepare</code> action hook (if one exists). If the prepare platform action is passed a file as an input, it will extract the file (relative to app-archives) into the specified deployment directory. The prepare user action hook is a place where users may execute custom code to modify the build result prior to its distribution to all of the application&#8217;s gears. An example use case for the prepare action hook is using it to download environment specific files that don&#8217;t belong in the application&#8217;s git repository to the build result directory. The build result may optionally be compressed to minimize disk space usage.</p>
</div>
<div class="paragraph">
<p>A build result that has been prepared for distribution is a <strong>deployment artifact</strong>. Deployment artifacts have unique identifiers (the sha1 sum of their contents) that are created/calculated by the prepare platform action, after the user-defined prepare action hook has been executed. Once a deployment artifact has been created, it may be distributed to some or all of an application&#8217;s gears.</p>
</div>
<div class="paragraph">
<p>After a deployment artifact has been distributed, it may then be activated. Activating a deployment artifact makes it the active code running for a gear. When activating a new deployment artifact, the old deployment artifact may be deleted (e.g., to save space), or it may be preserved. If the prior artifact is preserved, it will now be possible to roll back the active deployment artifact to the previous one, if a user so chooses.</p>
</div>
<div class="sect3">
<h4 id="new-application-configuration-options"><a class="anchor" href="#new-application-configuration-options"></a>New application configuration options</h4>
<div class="paragraph">
<p>New application configuration options are required to support the improved build and deployment features. These should be maintained in the broker and made available to the gears as environment variables.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>auto_deploy</strong></p>
<div class="paragraph">
<p>Possible values: true, false Default: true</p>
</div>
<div class="paragraph">
<p>Indicates if OpenShift should build and deploy automatically whenever the user executes <code>git push</code>. If not explicitly disabled, the current default behavior (to auto deploy) will remain the same.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If disabled, a <code>git push</code> will not result in the latest code being deployed to the application. Instead, the user must use the new <code>rhc deploy</code> command described below to initiate a deployment.</p>
</div>
<div class="paragraph">
<p>Additionally, the following marker files in the application git repository will be deprecated and replaced by optional arguments that can be passed to <code>rhc deploy</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>force_clean_build</code></p>
</li>
<li>
<p><code>hot_deploy</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any future options that are appropriate for a per deploy decision will only be added as deploy options such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a non-clean Maven build</p>
</li>
<li>
<p>running database migrations</p>
</li>
<li>
<p><strong>deployment_branch</strong></p>
<div class="paragraph">
<p>Possible values: any valid git branch Default: master</p>
</div>
<div class="paragraph">
<p>Indicates which branch should trigger an automatic deployment, if automatic deployment is enabled. If not specified, the current default behavior (master branch) will remain the same.</p>
</div>
<div class="paragraph">
<p>Pushes of branches other than the value specified by <code>deployment_branch</code> will not trigger an automatic deployment.</p>
</div>
</li>
<li>
<p><strong>keep_deployments</strong></p>
<div class="paragraph">
<p>Possible values: any number &gt;= 1 &#8656; configurable max<br>
Default: 1</p>
</div>
<div class="paragraph">
<p>Indicates how many total deployments to preserve. If not specified, the current default behavior of only preserving the current/active deployment will remain the same. This value must be &gt;= 2 for rollbacks to work.</p>
</div>
</li>
<li>
<p><strong>deployment_type</strong></p>
<div class="paragraph">
<p>Possible values: binary|git<br>
Default: git</p>
</div>
<div class="paragraph">
<p>Indicates whether the app is setup for binary or git based deployments. Deployments attempted of the type not configured will result in an error.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>These options will be configurable via an addition to <code>rhc</code>:</p>
</div>
<div class="paragraph">
<p><code>rhc config -a myapp &lt;option&gt; &lt;value&gt;</code></p>
</div>
<div class="paragraph">
<p>For example: <code>rhc config -a myapp auto_deploy false</code></p>
</div>
</div>
<div class="sect3">
<h4 id="new-ways-to-deploy"><a class="anchor" href="#new-ways-to-deploy"></a>New ways to deploy</h4>
<div class="paragraph">
<p>The following describes new ways to deploy a new version of code to an application. These assume that auto_deploy is false.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rhc deploy -a myapp &lt;git ref&gt;</code></p>
<div class="paragraph">
<p>Makes the specified git ref the active deployment running in the application. Possible valid git refs include:
<strong> a branch name, e.g. master. The tip of the branch will be deployed.
</strong> a commit id, such as d34dbe3f. That specific commit will be deployed.
** a tag, such as v1.0. That specific tag will be deployed.</p>
</div>
</li>
<li>
<p><code>rhc deploy -a myapp http://example.com/artifact_id-1.0.tar.gz</code></p>
<div class="paragraph">
<p>Makes the binary deployment artifact at the specified URL the active deployment for the application.</p>
</div>
</li>
<li>
<p><code>rhc deploy -a myapp myartifact.tar.gz</code></p>
<div class="paragraph">
<p>Uploads a binary deployment artifact located on the user&#8217;s computer to the application and makes it the active deployment.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="deployment-directory-structure"><a class="anchor" href="#deployment-directory-structure"></a>Deployment directory structure</h4>
<div class="paragraph">
<p>The following directory structure is proposed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>app-deployments/
  2013-08-16_14-36-36.881/
    dependencies/
    metadata/
      gitref
      id
      state
    repo/

  2013-08-16_18-12-15.746/
    dependencies/
    metadata/
      gitref
      id
      state
    repo/

  by-id
    fa93c9b -&gt; ../2013-08-16_14-36-36.881
    9191a7e -&gt; ../2013-08-16_18-12-15.746

app-archives/
  myapp-1.0.tar.gz
  myapp-2.0.tar.gz

app-root/
  dependencies -&gt; runtime/dependencies
  repo -&gt; runtime/repo
  runtime/
    dependencies -&gt; ../../app-deployments/2013-08-16_14-36-36.881/dependencies
    repo -&gt; ../../app-deployments/2013-08-16_14-36-36.881/repo</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>app-deployments</strong> directory contains 1 or more deployments in their entirety. A deployment directory name has the following format: [date]_[time], such as <code>2013-08-16_14-36-36.881</code>. The repo directory contains the contents of what will be in app-root/runtime/repo. The dependencies directory contains the contents of app-root/runtime/dependencies. The metadata directory contains information about the deployment: the git ref of the deployment (if applicable), the deployment id, and the deployment&#8217;s state (N/A or DEPLOYED).</p>
</div>
<div class="paragraph">
<p>The <strong>app-archives</strong> directory contains binary deployment artifacts that are the inputs to the <code>prepare</code> platform action.</p>
</div>
</div>
<div class="sect3">
<h4 id="git-deployments-current-openshift-workflow"><a class="anchor" href="#git-deployments-current-openshift-workflow"></a>Git deployments - current OpenShift workflow</h4>
<div class="paragraph">
<p>The following process will take place when <code>auto_deploy</code> is enabled, <code>keep_deployments</code> = 1, and the user pushes code to the git repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User invokes <code>git push</code></p>
</li>
<li>
<p>Application is stopped</p>
</li>
<li>
<p>The cartridge&#8217;s <code>pre-repo-archive</code> command is invoked</p>
</li>
<li>
<p>A new deployment directory <code>app-deployments/$date_$time</code> is created with <code>repo</code> and <code>dependencies</code> subdirectories</p>
</li>
<li>
<p>All dependencies from the active deployment (app-root/runtime/dependencies) are moved to <code>app-deployments/$date_$time/dependencies</code></p>
</li>
<li>
<p>Active deployment directory in <code>app-deployments/</code> is removed</p>
</li>
<li>
<p>The contents of the git repo for the current deployment branch are unpacked into <code>app-deployments/$date_$time/repo</code></p>
</li>
<li>
<p>A build is performed</p>
</li>
<li>
<p>The cartridge&#8217;s <code>pre_build</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>pre_build</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The cartridge&#8217;s <code>build</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>build</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The platform&#8217;s <code>prepare</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>prepare</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The deployment id is calculated from the contents of the deployment directory</p>
</li>
<li>
<p>The symlink <code>app-deployments/by-id/$deployment_id</code> is created and points to <code>../app-deployments/$date_time</code></p>
</li>
<li>
<p>The platform&#8217;s <code>distribute</code> command is invoked</p>
</li>
<li>
<p>If the app is scalable, the new deployment will be synced to all child gears</p>
</li>
<li>
<p>The platform&#8217;s <code>activate</code> command is invoked</p>
</li>
<li>
<p><code>app-root/runtime/repo</code> is updated to point at <code>../../app-deployments/$date_$time/repo</code></p>
</li>
<li>
<p><code>app-root/runtime/dependencies</code> is updated to point at <code>../../app-deployments/$date_$time/dependencies</code></p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>update-configuration</code> control action is invoked</p>
</li>
<li>
<p>The secondary cartridges are started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The primary cartridge is started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>post_deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>post_deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>If the app is scalable and the options did not include --child, for each child gear:</p>
</li>
<li>
<p>SSH to the child gear and execute <code>gear activate $deployment_id --child</code></p>
</li>
<li>
<p>Write DEPLOYED to app-deployments/latexmath:[$date_$]time/metadata/state</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="git-deployments-preserving-previous-deployments"><a class="anchor" href="#git-deployments-preserving-previous-deployments"></a>Git deployments - preserving previous deployments</h4>
<div class="paragraph">
<p>The following process will take place when <code>auto_deploy</code> is enabled, <code>keep_deployments</code> &gt; 1, and the user pushes code to the git repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User invokes <code>git push</code></p>
</li>
<li>
<p>Application is stopped</p>
</li>
<li>
<p>The cartridge&#8217;s <code>pre-repo-archive</code> command is invoked</p>
</li>
<li>
<p>A new deployment directory <code>app-deployments/$date_$time</code> is created with <code>repo</code> and <code>dependencies</code> subdirectories</p>
</li>
<li>
<p>All dependencies from the active deployment (app-root/runtime/dependencies) are copied (or moved if keep_deployments == 1) to <code>app-deployments/$date_$time/dependencies</code></p>
</li>
<li>
<p>Starting with the oldest deployment, previous deployments are removed until the number of deployments in app-deployments &#8656; the value of keep_deployments (if necessary)</p>
</li>
<li>
<p>The contents of the git repo for the current deployment branch are unpacked into <code>app-deployments/$date_$time/repo</code></p>
</li>
<li>
<p>A build is performed</p>
</li>
<li>
<p>The cartridge&#8217;s <code>pre_build</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>pre_build</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The cartridge&#8217;s <code>build</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>build</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The platform&#8217;s <code>prepare</code> command is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>prepare</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The deployment id and checksum of deployment contents are calculated</p>
</li>
<li>
<p>The symlink <code>app-deployments/by-id/$deployment_id</code> is created and points to <code>../app-deployments/$date_time</code></p>
</li>
<li>
<p>The platform&#8217;s <code>distribute</code> command is invoked</p>
</li>
<li>
<p>If the app is scalable, the new deployment will be synced to all child gears</p>
</li>
<li>
<p>The platform&#8217;s <code>activate</code> command is invoked</p>
</li>
<li>
<p><code>app-root/runtime/repo</code> is updated to point at <code>../../app-deployments/$date_$time/repo</code></p>
</li>
<li>
<p><code>app-root/runtime/dependencies</code> is updated to point at <code>../../app-deployments/$date_$time/dependencies</code></p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>update-configuration</code> control action is invoked</p>
</li>
<li>
<p>The secondary cartridges are started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The primary cartridge is started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>post_deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>post_deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>If the app is scalable, SSH to each child gear and execute gear activate $deployment_id</p>
</li>
<li>
<p>Write activation time to app-deployments/latexmath:[$date_$]time/metadata.json</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="binary-deployments"><a class="anchor" href="#binary-deployments"></a>Binary deployments</h4>
<div class="paragraph">
<p>Sometimes it doesn&#8217;t make sense to use git to deploy an application. Git is not a particularly efficient means of deploying a pre-built Java .war file, for example.</p>
</div>
<div class="paragraph">
<p>A binary deployment artifact could be one of the following formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tar</p>
</li>
<li>
<p>tar.gz</p>
</li>
<li>
<p>tar.bz2</p>
</li>
<li>
<p>zip</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because git-based deployments remain the default mechanism, a user will have to manually convert an application to use binary deployments using a new config option <code>deployment_type</code> which corresponds to the environment variable: OPENSHIFT_DEPLOYMENT_TYPE=binary. If this variable does not exist, the default behavior to use git for deployments will remain the same. The other possible value for this variable is OPENSHIFT_DEPLOYMENT_TYPE=git, which has the same effect as the variable not being set.</p>
</div>
<div class="paragraph">
<p>A binary artifact is deployed by running a command such as <code>rhc deploy -a &lt;app&gt; &lt;url&gt;</code>, where <code>&lt;url&gt;</code> refers to the binary artifact to be deployed. The <code>&lt;url&gt;</code> could be a remote link, or a local file.</p>
</div>
<div class="paragraph">
<p>The proposed format of a binary artifact is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>repo
  .openshift
    ...
  application-specific files
dependencies
  ...</pre>
</div>
</div>
<div class="paragraph">
<p>A .war binary deployment artifact might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>repo
  .openshift
    ...
  deployments
    ROOT.war
dependencies
  ...</pre>
</div>
</div>
<div class="paragraph">
<p>Essentially the artifact contains exactly what app-root/runtime/repo would have after a build has taken place.</p>
</div>
<div class="paragraph">
<p>The following process will take place when <code>auto_deploy</code> is disabled, <code>keep_deployments</code> &gt; 1, and the user executes <code>rhc deploy -a myapp &lt;url&gt;</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User invokes <code>rhc deploy -a myapp &lt;url&gt;</code></p>
</li>
<li>
<p>A new deployment directory <code>app-deployments/$date_$time</code> is created with <code>repo</code> and <code>dependencies</code> subdirectories</p>
</li>
<li>
<p>Starting with the oldest deployment, previous deployments are removed until the number of deployments in <code>app-deployments</code> &#8656; the value of <code>keep_deployments</code> (if necessary)</p>
</li>
<li>
<p>The platform&#8217;s <code>prepare</code> command is invoked</p>
</li>
<li>
<p>The file specified by is downloaded and extracted to <code>app-deployments/$date_$time</code></p>
</li>
<li>
<p>The user&#8217;s <code>prepare</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The deployment id and checksum of deployment contents are calculated</p>
</li>
<li>
<p>The symlink <code>app-deployments/by-id/$deployment_id</code> is created and points to <code>../app-deployments/$date_time</code></p>
</li>
<li>
<p>The platform&#8217;s <code>distribute</code> command is invoked</p>
</li>
<li>
<p>If the app is scalable, the new deployment will be synced to all child gears</p>
</li>
<li>
<p>The platform&#8217;s <code>activate</code> command is invoked</p>
</li>
<li>
<p><code>app-root/runtime/repo</code> is updated to point at <code>../../app-deployments/$date_$time/repo</code></p>
</li>
<li>
<p><code>app-root/runtime/dependencies</code> is updated to point at <code>../../app-deployments/$date_$time/dependencies</code></p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>update-configuration</code> control action is invoked</p>
</li>
<li>
<p>The secondary cartridges are started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>The primary cartridge is started</p>
</li>
<li>
<p>The primary cartridge&#8217;s <code>post_deploy</code> control action is invoked</p>
</li>
<li>
<p>The user&#8217;s <code>post_deploy</code> hook is invoked, if it exists</p>
</li>
<li>
<p>If the app is scalable, SSH to each child gear and execute gear activate $deployment_id</p>
</li>
<li>
<p>Write activate time to app-deployments/latexmath:[$date_$]time/metadata.json</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="node-api"><a class="anchor" href="#node-api"></a>Node API</h4>
<div class="paragraph">
<p>This section describes the API for the following foundational actions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build: create a deployment from the application&#8217;s git-repo</p>
</li>
<li>
<p>Prepare: prepare a deployment for distribution and activation</p>
</li>
<li>
<p>Distribute: copy a deployment to web gears in an application</p>
</li>
<li>
<p>Activate: Begin running a deployment on the web gears in an application</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each workflow phase implements a contract:</p>
</div>
<div class="paragraph">
<p><strong>Build</strong></p>
</div>
<div class="paragraph">
<p>Inputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>deployment_request_id</code>: use a prior deployment instead of the current repo for the build</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Combined output of all actions as a String</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Effects:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>dependencies</code> and <code>build_dependencies</code> symlinks are updated to point to the <code>deployment_request_id</code>, if it is supplied.</p>
</li>
<li>
<p><code>update-configuration</code>, <code>pre-build</code>, and <code>build</code> control actions are run on the primary cartridge</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Failure Modes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If <code>deployment_request_id</code> is supplied and does not exist, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>Restart the application as the gear user if a build failure occurs and <code>$OPENSHIFT_KEEP_DEPLOYMENTS</code> is greater than 1.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Prepare</strong></p>
</div>
<div class="paragraph">
<p>Prepare a deployment artifact from a deployment request.</p>
</div>
<div class="paragraph">
<p>Inputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>deployment_request_id</code>: datetime of the deployment to prepare</p>
</li>
<li>
<p><code>file</code>: an archive file to use in place of a deployment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Combined output of all actions as a String</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Effects:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A new deployment id is calculated from the deployment request</p>
</li>
<li>
<p>A symlink is created in the by-id directory for the deployment id</p>
</li>
<li>
<p>The deployment metadata for the id is updated to point to the new id</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Failure Modes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If <code>deployment_request_id</code> is not supplied, raise an ArgumentError</p>
</li>
<li>
<p>If a fault occurs after a link is created in the by-id directory, it is unlinked.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Distribute</strong></p>
</div>
<div class="paragraph">
<p>Copy a deployment to gears in the application.</p>
</div>
<div class="paragraph">
<p>Inputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>gears</code>: the gears to distribute to. Optional; defaults to other web framework gears in the application.</p>
</li>
<li>
<p><code>deployment_id</code>: the ID of the deployment to distribute.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  status: :success # or :failure,
  results: {
    #{gear_uuid}: {
      gear_uuid: #{gear_uuid},
      status: :success, # or :failure
      messages: [],
      errors: []
    }, …
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Failure Modes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If no deployment ID is supplied, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>If distribute to a gear fails, retry up to two times before considering that gear to have failed.</p>
</li>
<li>
<p>If distributing to any gear fails, the entire operation is a failure, but the platform will continue distributing to other gears in the application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Activate</strong></p>
</div>
<div class="paragraph">
<p>Run a deployment on gears in the application.</p>
</div>
<div class="paragraph">
<p>Inputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>gears</code>: the gears on which to activate a deployment. Optional; defaults to other web framework gears in the application.</p>
</li>
<li>
<p><code>deployment_id</code>: the ID of the deployment to activate.</p>
</li>
<li>
<p><code>init</code>: Run the web cartridge&#8217;s <code>post-install</code> workflow after activating the deployment. Optional; defaults to <code>false</code>.</p>
</li>
<li>
<p><code>hot_deploy</code>: Do not disable the gear in the cluster during activation. Controlled by the app&#8217;s hot deployment setting; defaults to <code>false</code>.</p>
</li>
<li>
<p><code>out</code>:</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  status: :success # or :failure,
  results: {
    #{gear_uuid}: {
      gear_uuid: #{gear_uuid},
      status: :success, # or :failure
      messages: [],
      errors: []
    }, …
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Failure modes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If no deployment ID is supplied, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>If any gear activation fails, the entire operation is a failure, but the platform will continue activating on other gears in the app.</p>
</li>
<li>
<p>If remote activation of a gear returns a non-zero exit code, generate a failure result for that gear.</p>
</li>
<li>
<p>If disabling a gear in any proxy fails, activation of that gear is a failure. App is now potentially partially disabled across the cluster.</p>
</li>
<li>
<p>If enabling a gear in any proxy fails, activation of that gear is a failure. App is not potentially partially disabled across the cluster.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Update Proxy Status</strong></p>
</div>
<div class="paragraph">
<p>Change the status of a gear in the proxies for the app.</p>
</div>
<div class="paragraph">
<p>Inputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>action</code>: action to perform (disable/enable)</p>
</li>
<li>
<p><code>gear_uuid</code>: gear to change status for</p>
</li>
<li>
<p><code>cartridge</code>: the web proxy cartridge</p>
</li>
<li>
<p><code>persist</code>: store the status change in the proxy config file</p>
</li>
<li>
<p><code>requesting_gear_uuid</code>: uuid of the gear requesting the status change</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  status: :success, # or :failure
  target_gear_uuid: #{gear_uuid}
  proxy_results: {
    #{proxy_gear_uuid}: {
      proxy_gear_uuid: #{proxy_gear_uuid},
      status: :success, # or :failure,
      messages: [], # strings
      errors: [] # strings
    }, ...
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Failure Modes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If no valid action is supplied, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>If no gear uuid is supplied, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>If no cartridge is supplied, and there is no web proxy cartridge, raise an <code>ArgumentError</code>.</p>
</li>
<li>
<p>If updating the status of the gear in any proxy fails, the operation is considered a failure, but the platform will continue updating the status of the gear in other proxies.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deployment-rollback-capability"><a class="anchor" href="#deployment-rollback-capability"></a>Deployment rollback capability</h4>
<div class="paragraph">
<p>OpenShift must support an easy way to rollback from one deployment to the previous one. To do so, the previous deployment must be preserved.</p>
</div>
<div class="paragraph">
<p>To perform a rollback, the following command will be added: <code>rhc deploy -a myapp --rollback</code></p>
</div>
<div class="paragraph">
<p>This will execute the following sequence of actions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that a previous deployment exists; return error to the user if not</p>
</li>
<li>
<p>Stop the application</p>
</li>
<li>
<p>Delete the current deployment directory (<code>app-root/runtime/repo/..</code>)</p>
</li>
<li>
<p>The previous deployment&#8217;s deployment ID is read from metadata/id</p>
</li>
<li>
<p>The platform&#8217;s <code>activate</code> command is invoked for the previous deployment ID (see above for details)</p>
</li>
<li>
<p>If the app is scalable and the options did not include --child, for each child gear:</p>
</li>
<li>
<p>SSH to the child gear and execute <code>gear rollback --child</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="types-of-applications-and-deployments"><a class="anchor" href="#types-of-applications-and-deployments"></a>Types of applications and deployments</h4>
<div class="paragraph">
<p>There are three likely scenarios under which applications are deployed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A simple, non scalable app that may have limited disk space</p>
</li>
<li>
<p>A scaled app that may have limited disk space</p>
</li>
<li>
<p>A scaled app with sufficient disk space for storing multiple deployments</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Most production level apps are assumed to fall in category 3. Most development apps are assumed to fall in categories 1 (pure development) or 2 (testing). Applications in #2 are supported, but not extensively optimized for availability. The further into category #3 applications fall, the more they need to be optimized for performance and speed of deployment.</p>
</div>
<div class="paragraph">
<p>In addition, users may desire to deploy using two distinct methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Scale-replace</strong></p>
<div class="paragraph">
<p>Create new gears with the new deployment artifact and scale down gears running the older deployment. The new gears must have the new deployment artifact copied after creation.</p>
</div>
</li>
<li>
<p><strong>In-place</strong></p>
<div class="paragraph">
<p>Change gears in place, with or without altering the scale factor. Predeploys the new deployment artifact to a temporary location, stops the gear, copies the new artifact to become the active deployment, and the starts the gear.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>A concrete limitation of scale-replace is that the head gear in non HA applications must still be updated at low scale factors (N&lt;3) via an in-place deploy (since the head gear cannot be scaled). An advantage of the scale-replace is that it forces stateless gears and ensures movement across nodes of active content (beneficial for load balancing). A downside is that gears are always cold.</p>
</div>
<div class="paragraph">
<p>The minimum deployment time for scale-replace is described by</p>
</div>
<div class="listingblock">
<div class="content">
<pre>T(deploy) = ( N(gears) / N(extra_cap) - 1 ) * ( T(gear_create) + T(gear_deploy) + T(gear_activate) )</pre>
</div>
</div>
<div class="paragraph">
<p>where N(gears) is the number of gears in the application, N(extra_cap) is the extra capacity in number of gears, T(gear_create) is the time to create a new gear with an instance of the cartridges, T(gear_deploy) is the time to copy the deployment artifact onto disk from the source, and T(gear_activate) is the time to swap the artifact to the newly deployed version and start the gear.</p>
</div>
<div class="paragraph">
<p>The minimum deployment time for in-place is (because gear_deploy can be executed before the deployment begins):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>T(deploy) = ( N(gears) / ( N(extra_cap) + N(fraction) ) - 1 ) * ( T(gear_activate) )</pre>
</div>
</div>
<div class="paragraph">
<p>Where N(fraction) = N(gears) * number of gears that are allowed to be down at any given point in time. For example, there are 10 gears and only 1 gear is allowed to be down at a time. As such, there will be (10 / (0 + (10*.1)) – 1 * activate time == 9 * activate time.</p>
</div>
<div class="paragraph">
<p>There is no combination of factors where scale-replace is faster than in-place.</p>
</div>
<div class="paragraph">
<p>Some large installations may not have access to sufficient floating capacity to accomplish their update within specific time constraints - they will wish to trade increased disk usage for increased speed / decreased overall deployment time. Some users will wish to try simple deploys with limited disk space - that can be accomplished with scale-replace.</p>
</div>
<div class="paragraph">
<p>Therefore, we recommend scale-replace when per-gear disk space (i.e., quota) is limited and availability is desired (category 2), and in-place for unscaled, disk limited apps (category 1) and high scale, disk unlimited apps (category 3). It is recommended that application owners must provision sufficient capacity for in-place and opt-in to that deployment method.</p>
</div>
</div>
<div class="sect3">
<h4 id="zero-downtime-deployments"><a class="anchor" href="#zero-downtime-deployments"></a>Zero-downtime deployments</h4>
<div class="paragraph">
<p>It should be possible to deploy to a scaled application without incurring application downtime. To accomplish this, either scale-replace or in-place deployments could be used. If in-place, the application must have at least 2 gears to avoid downtime.</p>
</div>
</div>
<div class="sect3">
<h4 id="broker-involvement"><a class="anchor" href="#broker-involvement"></a>Broker involvement</h4>
<div class="paragraph">
<p>With the added ability to deploy any git ref as well as binary deployments, there needs to be a way to know what version of the application is deployed on a gear. This information should reside in the gear itself, and it should also be communicated back to the broker, so the broker can persist it.</p>
</div>
<div class="paragraph">
<p>The broker should maintain the current state of all of an application&#8217;s gears, including the current deployment id and information about previous deployments. Whenever a deployment or rollback succeeds, the platform should inform the broker of the changes to each gear&#8217;s deployments.</p>
</div>
<div class="paragraph">
<p>The gear will be treated as the system or record, so in the event of a discrepancy between the gear and the broker, the gear will "win."</p>
</div>
<div class="paragraph">
<p>If the broker is not available, it should still be possible to perform deployments and rollbacks. We should consider a "fallback" mode where a deployment can be directed by an external process using only the capabilities available on the gears. This fallback mode has already been implemented in a production environment, so the focus should be on integrating that logic into <code>rhc</code> in "director mode". This may be accomplished by ensuring that the build, prepare, distribute, and activate steps can be invoked via shell in any gear with a Git repo (they take simple arguments) - the remaining reporting and coordination can be maintained by an external tool.</p>
</div>
<div class="paragraph">
<p>An example application might consist of 3 redundant head gears, with 10 other scaled web gears. The coordinator would be able to execute the following SSH session to reproduce the in-place deploy of a commit f03435b:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ssh gearid1@myapp-mydomain.rhcloud.com
Connecting to gearid1@myapp-mydomain.rhcloud.com...
&gt; build f03435b
Building Git commit f03435b....
....
Build complete, prepared deployment artifacts in app-deployments/20130305_120034-d3948b93
Deployment id is d3948b93
&gt; distribute d3948b93
Copying d3948b93 to all gears
.....
[gear 4] connection denied
d3948b93 distributed to 12/13 gears.  1 failure.
&gt; activate d3948b93 --disable-missing --step=2
[gear 4] removed from active rotation
[gear 1] updated to d3948b93
[gear 2] updated to d3948b93
...
d3948b93 activated on 12/13 gears. 1 gear removed from rotation.</pre>
</div>
</div>
<div class="paragraph">
<p>The broker would also make use of the steps in this process, and report data in the appropriate format. More work is needed to isolate the exact separation points in the gear and platform.</p>
</div>
<div class="paragraph">
<p>Deploy will also be exposed through a REST API to be used from any non ssh clients. The REST API will be (non binary deploy):</p>
</div>
<div class="paragraph">
<p><code>POST /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/events?event=deploy</code></p>
</div>
<div class="paragraph">
<p>This operation will perform the build and deploy and take the same options provided through ssh (force_clean_build, git ref, etc). Output will need to be accessible through standard gear logging facilities.</p>
</div>
</div>
<div class="sect3">
<h4 id="storage-considerations"><a class="anchor" href="#storage-considerations"></a>Storage considerations</h4>
<div class="paragraph">
<p>In OpenShift environments where users have constrained file quotas (e.g. 1GB in Online), it may not be desirable (or even possible) to keep 2 copies of different releases on disk at the same time (N, N+1).</p>
</div>
<div class="paragraph">
<p>If a gear runs out of disk space during a deployment, the platform will remove 1 or more previous deployments (if they exist) in an effort to keep the gear below its quota limit.</p>
</div>
</div>
<div class="sect3">
<h4 id="haproxy-changes"><a class="anchor" href="#haproxy-changes"></a>HAProxy changes</h4>
<div class="paragraph">
<p>The HAProxy cartridge is currently responsible for synchronizing an application&#8217;s files from the head gear to the child gears. This synchronization happens automatically whenever a user executes <code>git push</code> to update an application. This functionality should be moved from the HAProxy cartridge to the platform. If other web proxies besides HAProxy are available at some point in the future, each would have to implement file synchronization; as a result, this should be handled by the platform to avoid duplicate file synchronization implementations.</p>
</div>
<div class="paragraph">
<p>When the platform synchronizes files, the synchronization will happen before all cartridge and user deploy hooks are executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="additional-dependencies"><a class="anchor" href="#additional-dependencies"></a>Additional dependencies</h4>
<div class="paragraph">
<p>Some frameworks have external dependencies that are required at build time, run time, or both. These often do not reside with the application&#8217;s source code and are often downloaded during a build or deployment. Examples include Java dependencies retrieved via Maven, node.js modules, Python virtenv files, etc. We will track the state of these external dependencies per deployment, and be able to tie the set of files that exist at a given point in time to a given deployment. Cartridges can accomplish this by storing their dependencies under app-root/runtime/dependencies and linking to that directory if their framework requires a particular directory structure. Ex:</p>
</div>
<div class="paragraph">
<p>php/phplib &#8594; app-root/runtimedependencies/phplib</p>
</div>
<div class="sect4">
<h5 id="publisher-gears"><a class="anchor" href="#publisher-gears"></a>Publisher gears</h5>
<div class="paragraph">
<p>1 possible way to implement these changes to deployments is to create a gear that is dedicated to performing builds and deployments to the real application gears. Individual deployments reside on the publisher gear, and they would be synchronized to the real application gears at deployment time. Instead of each application gear being required to maintain a copy of the last 1 or 2 deployments (to support rollback), the publisher gear could house the deployments, limiting the amount of duplication necessary (in the event that every child gear had to have a copy of deployments <em>n</em>, <em>n-1</em>, and possibly <em>n-2</em>.</p>
</div>
<div class="paragraph">
<p>Publisher gears would need to be redundant to avoid being a single point of failure.</p>
</div>
</div>
<div class="sect4">
<h5 id="deployment-failures-errors"><a class="anchor" href="#deployment-failures-errors"></a>Deployment failures/errors</h5>
<div class="paragraph">
<p>In the event that a deployment to a gear fails, the user should be notified of the failure. No attempt at auto-correcting the failure will be made, and the user will be required to fix whatever the issue is.</p>
</div>
</div>
<div class="sect4">
<h5 id="deployment-validation"><a class="anchor" href="#deployment-validation"></a>Deployment validation</h5>
<div class="paragraph">
<p>At the end of a deployment, the platform should validate that the deployment succeeded. This could be as simple as validating the contents of a deployment status file on a gear.</p>
</div>
</div>
<div class="sect4">
<h5 id="targeting-specific-gears"><a class="anchor" href="#targeting-specific-gears"></a>Targeting specific gears</h5>
<div class="paragraph">
<p>It may be desirable to allow the user to target one or more specific gears when performing a deployment/restart. A potential scenario would involve deploying a new release to 10% of an application&#8217;s gears, smoke testing the new release on those gears, and then continuing to deploy to the remaining gears if the smoke test passed.</p>
</div>
</div>
<div class="sect4">
<h5 id="graceful-shutdowns-draining-connections"><a class="anchor" href="#graceful-shutdowns-draining-connections"></a>Graceful shutdowns / draining connections</h5>
<div class="paragraph">
<p>Before performing any deployment or restart operation, active connections to a gear should be gracefully drained. This is usually accomplished by modifying the load balancer (haproxy) to disallow new connections while allowing established connections to complete their work.</p>
</div>
<div class="paragraph">
<p>There may potentially be issues if versions <em>n</em> and <em>n+1</em> are both active at the same time and HTTP session replication is in use. Dealing with these is out of scope of this PEP.</p>
</div>
</div>
<div class="sect4">
<h5 id="health-checks"><a class="anchor" href="#health-checks"></a>Health Checks</h5>
<div class="paragraph">
<p>OpenShift currently only supports HTTP health checks at "/". While this is acceptable for many applications, there are definitely times when an application is not deployed at /, or when a non-HTTP health check is desired. It may be useful for an application to be able to define 1 or more health checks that the platform should execute. This could be done in a file in the application&#8217;s .openshift directory hierarchy, such as .openshift/configuration/health_checks.yml or .openshift/configuration/application.yml.</p>
</div>
<div class="paragraph">
<p>In this file, the user could specify 1 or more health checks. Each health check could be performed by the load balancer (haproxy) for web applications, or by the platform for non web applications. Non web health checks would require the platform to execute a script specified by the user in the configuration file. If the script returns success (0), the application is considered healthy. Any nonzero return code indicates unhealthy/failure.</p>
</div>
</div>
<div class="sect4">
<h5 id="build-when-notified-by-an-external-source-push"><a class="anchor" href="#build-when-notified-by-an-external-source-push"></a>Build when notified by an external source push</h5>
<div class="paragraph">
<p>*NOTE: Speculative</p>
</div>
<div class="paragraph">
<p>A user desires to deploy when commits are pushed to an external GitHub repository. They configure their application for build-on-push to "master", and ensure their internal application repository is a clone of the upstream. They then enable web hook support via the broker for their application by creating a new authorization with application web-hook scope. The broker will then accept a POST request to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/broker/rest/applications/&lt;appuuid&gt;/webhooks/&lt;token_value&gt;/&lt;action&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>which is passed directly to one of the application web gears for processing. The platform code would look for a .openshift/action_hooks/webhook script and execute it with the arguments</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;action&gt; &lt;payload&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>where payload is is the payload parameter passed to the broker in JSON. The webhook script would execute a simple git fetch against an upstream, and then git push that upstream to the local repository in the background and return.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="distributed-publishing-multi-master-multi-ha"><a class="anchor" href="#distributed-publishing-multi-master-multi-ha"></a>Distributed Publishing (Multi-Master / Multi-HA)</h4>
<div class="paragraph">
<p>A scaled application currently has a single master git repository, while the child gears only receive copies of files necessary for deployment. To remove the single master from being a single point of failure, all child gears should also receive a copy of the master git repository. Their copies would be read-only. If the current master dies at some point, any of the child gears should be able to be elevated to be the new master.</p>
</div>
<div class="paragraph">
<p>**Details to follow HA implementation</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backwards-compatibility"><a class="anchor" href="#backwards-compatibility"></a>Backwards Compatibility</h3>
<div class="paragraph">
<p>The details and changes described in this PEP should be fully backwards compatible with previous releases. None of the default behaviors change (<code>git push</code> still builds and deploys master). It is possible, maybe even likely that the directory structure for deployments may have to change slightly, and this could be addressed as part of a migration/upgrade script. Newer features, such as the ability to deploy binary artifacts, would only be available to a fully upgraded OpenShift installation. Older clients should continue to function without anything breaking.</p>
</div>
</div></div>
<div id="footer">
<div id="footer-text">
<br>
Last updated 2015-01-08 00:12:03 EST
</div>
<!-- Google Analytics -->
<script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40375612-1']);
  _gaq.push(['_setDomainName', 'openshift.github.io']);
  _gaq.push(['_trackPageview']);
  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  
  $(document).ready(function() {
    _gaq.push(function() {
      $('a:not([href^="http"])').on("click", function(e) {
        e.preventDefault();
        var link = $(this).attr("href");
        _gaq.push(["_trackEvent", "Internal Links", "click", link]);
        setTimeout('document.location = "' + link + '"', 300);
      });
      $('a[href^="http"]').on("click", function(e) {
        e.preventDefault();
        var link = $(this).attr("href");
        _gaq.push(["_trackEvent", "Outbound Links", "click", link]);
        setTimeout('document.location = "' + link + '"', 300);
      });
    });
  });
</script>
<!-- Google Code for Remarketing -->
<script>
  var google_conversion_id = 1007064360;
  var google_conversion_label = "7jfmCMC5ugQQqKqa4AM";
  var google_custom_params = window.google_tag_params;
  var google_remarketing_only = true;
</script>
<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script>
<noscript>
<div style="display: inline;">
<img alt="" height="1" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1007064360/?value=0&amp;label=7jfmCMC5ugQQqKqa4AM&amp;guid=ON&amp;script=0" style="border-style: none;" width="1">
</div>
</noscript>
</div>
</body>
</html>