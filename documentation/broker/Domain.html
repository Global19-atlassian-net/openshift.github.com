<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Domain
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (D)</a> &raquo;
    
    
    <span class="title">Domain</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Domain
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Domain</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="Membership.html" title="Membership (module)">Membership</a></span>, Mongoid::Document, Mongoid::Timestamps</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/home/fedora/origin-server/controller/app/models/domain.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Represents a OpenShift Domain. A <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> can own multiple domains.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="NAMESPACE_MAX_LENGTH-constant" class="">NAMESPACE_MAX_LENGTH =
          
        </dt>
        <dd><pre class="code"><span class='int'>16</span></pre></dd>
      
        <dt id="NAMESPACE_MIN_LENGTH-constant" class="">NAMESPACE_MIN_LENGTH =
          
        </dt>
        <dd><pre class="code"><span class='int'>1</span></pre></dd>
      
        <dt id="DOMAIN_NAME_REGEX-constant" class="">DOMAIN_NAME_REGEX =
          <div class="docstring">
  <div class="discussion">
    
<p>This is the current regex for validations for new domains</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#application_count-instance_method" title="#application_count (instance method)">- (Object) <strong>application_count</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>non-persisted fields used to store info about the applications in this
domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#applications-instance_method" title="#applications (instance method)">- (Array[Application]) <strong>applications</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#available_gears-instance_method" title="#available_gears (instance method)">- (Object) <strong>available_gears</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute available_gears.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#env_vars-instance_method" title="#env_vars (instance method)">- (Array[Hash]) <strong>env_vars</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List of domain wide environment variables to be created on all
<span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#gear_counts-instance_method" title="#gear_counts (instance method)">- (Object) <strong>gear_counts</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute gear_counts.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#max_storage_per_gear-instance_method" title="#max_storage_per_gear (instance method)">- (Object) <strong>max_storage_per_gear</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute max_storage_per_gear.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#namespace-instance_method" title="#namespace (instance method)">- (String) <strong>namespace</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Namespace reserved for this domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#owner-instance_method" title="#owner (instance method)">- (CloudUser) <strong>owner</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> that owns this domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pending_ops-instance_method" title="#pending_ops (instance method)">- (Array[PendingDomainOps]) <strong>pending_ops</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List of <span class='object_link'><a href="PendingDomainOps.html" title="PendingDomainOps (class)">PendingDomainOps</a></span> that need to be performed on this domain.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#system_ssh_keys-instance_method" title="#system_ssh_keys (instance method)">- (Array[SystemSshKey]) <strong>system_ssh_keys</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List of SSH keys to be made available on all <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the
domain.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_name%21-class_method" title="check_name! (class method)">+ (Object) <strong>check_name!</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sort_by_original-class_method" title="sort_by_original (class method)">+ (Object) <strong>sort_by_original</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#validation_map-class_method" title="validation_map (class method)">+ (Object) <strong>validation_map</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_gear_counts-class_method" title="with_gear_counts (class method)">+ (Object) <strong>with_gear_counts</strong>(domains = queryable) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_env_variables-instance_method" title="#add_env_variables (instance method)">- (Object) <strong>add_env_variables</strong>(variables, skip_node_ops = false) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_system_ssh_keys-instance_method" title="#add_system_ssh_keys (instance method)">- (Object) <strong>add_system_ssh_keys</strong>(ssh_keys, skip_node_ops = false) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#inherit_membership-instance_method" title="#inherit_membership (instance method)">- (Object) <strong>inherit_membership</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#members_changed-instance_method" title="#members_changed (instance method)">- (Object) <strong>members_changed</strong>(added, removed, changed_roles) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_env_variables-instance_method" title="#remove_env_variables (instance method)">- (Object) <strong>remove_env_variables</strong>(remove_key, skip_node_ops = false) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_system_ssh_keys-instance_method" title="#remove_system_ssh_keys (instance method)">- (Object) <strong>remove_system_ssh_keys</strong>(remove_key, skip_node_ops = false) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_jobs-instance_method" title="#run_jobs (instance method)">- (Object) <strong>run_jobs</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Runs all jobs in “init” phase and stops at the first failure.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#save_with_duplicate_check%21-instance_method" title="#save_with_duplicate_check! (instance method)">- (Object) <strong>save_with_duplicate_check!</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Invoke save! with a rescue for a duplicate exception.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_gear_counts-instance_method" title="#with_gear_counts (instance method)">- (Object) <strong>with_gear_counts</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Membership.html" title="Membership (module)">Membership</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Membership.html#add_members-instance_method" title="Membership#add_members (method)">#add_members</a></span>, <span class='object_link'><a href="Membership.html#change_member_roles-instance_method" title="Membership#change_member_roles (method)">#change_member_roles</a></span>, <span class='object_link'><a href="Membership.html#changing_members-instance_method" title="Membership#changing_members (method)">#changing_members</a></span>, <span class='object_link'><a href="Membership.html#default_members-instance_method" title="Membership#default_members (method)">#default_members</a></span>, <span class='object_link'><a href="Membership.html#default_role-instance_method" title="Membership#default_role (method)">#default_role</a></span>, <span class='object_link'><a href="Membership.html#explicit_members_are_limited-instance_method" title="Membership#explicit_members_are_limited (method)">#explicit_members_are_limited</a></span>, <span class='object_link'><a href="Membership.html#handle_member_changes-instance_method" title="Membership#handle_member_changes (method)">#handle_member_changes</a></span>, <span class='object_link'><a href="Membership.html#has_member%3F-instance_method" title="Membership#has_member? (method)">#has_member?</a></span>, <span class='object_link'><a href="Membership.html#has_member_changes%3F-instance_method" title="Membership#has_member_changes? (method)">#has_member_changes?</a></span>, <span class='object_link'><a href="Membership.html#member_ids-instance_method" title="Membership#member_ids (method)">#member_ids</a></span>, <span class='object_link'><a href="Membership.html#parent_membership_relation-instance_method" title="Membership#parent_membership_relation (method)">#parent_membership_relation</a></span>, <span class='object_link'><a href="Membership.html#queue_op-instance_method" title="Membership#queue_op (method)">#queue_op</a></span>, <span class='object_link'><a href="Membership.html#remove_members-instance_method" title="Membership#remove_members (method)">#remove_members</a></span>, <span class='object_link'><a href="Membership.html#reset_members-instance_method" title="Membership#reset_members (method)">#reset_members</a></span>, <span class='object_link'><a href="Membership.html#role_for-instance_method" title="Membership#role_for (method)">#role_for</a></span></p>

  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="AccessControlled.html" title="AccessControlled (module)">AccessControlled</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="AccessControlled.html#owned_by%3F-instance_method" title="AccessControlled#owned_by? (method)">#owned_by?</a></span></p>

  
  
  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="application_count=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="application_count-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>application_count</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>non-persisted fields used to store info about the applications in this
domain</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 51</span>

<span class='kw'>def</span> <span class='id identifier rubyid_application_count'>application_count</span>
  <span class='ivar'>@application_count</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="applications-instance_method">
  
    - (<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>]</tt>) <strong>applications</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>]</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="available_gears=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="available_gears-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>available_gears</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute available_gears</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 53</span>

<span class='kw'>def</span> <span class='id identifier rubyid_available_gears'>available_gears</span>
  <span class='ivar'>@available_gears</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="env_vars-instance_method">
  
    - (<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="Hash.html" title="Hash (class)">Hash</a></span>]</tt>) <strong>env_vars</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List of domain wide environment variables to be created on all
<span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain. @see <span class='object_link'><a href="#add_env_variables-instance_method" title="Domain#add_env_variables (method)">#add_env_variables</a></span>,
<span class='object_link'><a href="#remove_env_variables-instance_method" title="Domain#remove_env_variables (method)">#remove_env_variables</a></span></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="Hash.html" title="Hash (class)">Hash</a></span>]</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>List of domain wide environment variables to be created on all
<span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the domain. @see <span class='object_link'><a href="#add_env_variables-instance_method" title="Domain#add_env_variables (method)">#add_env_variables</a></span>,
<span class='object_link'><a href="#remove_env_variables-instance_method" title="Domain#remove_env_variables (method)">#remove_env_variables</a></span></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="gear_counts=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="gear_counts-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>gear_counts</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute gear_counts</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_gear_counts'>gear_counts</span>
  <span class='ivar'>@gear_counts</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="max_storage_per_gear=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="max_storage_per_gear-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>max_storage_per_gear</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute max_storage_per_gear</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


54
55
56</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 54</span>

<span class='kw'>def</span> <span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span>
  <span class='ivar'>@max_storage_per_gear</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="namespace=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="namespace-instance_method">
  
    - (<tt>String</tt>) <strong>namespace</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Namespace reserved for this domain. @see #update_namespace</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Namespace reserved for this domain. @see #update_namespace</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="owner-instance_method">
  
    - (<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>) <strong>owner</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> that owns this domain.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> that owns this domain.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="pending_ops-instance_method">
  
    - (<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="PendingDomainOps.html" title="PendingDomainOps (class)">PendingDomainOps</a></span>]</tt>) <strong>pending_ops</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List of <span class='object_link'><a href="PendingDomainOps.html" title="PendingDomainOps (class)">PendingDomainOps</a></span> that need to be performed on this domain.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="PendingDomainOps.html" title="PendingDomainOps (class)">PendingDomainOps</a></span>]</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>List of <span class='object_link'><a href="PendingDomainOps.html" title="PendingDomainOps (class)">PendingDomainOps</a></span> that need to be performed on this domain.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="system_ssh_keys-instance_method">
  
    - (<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="SystemSshKey.html" title="SystemSshKey (class)">SystemSshKey</a></span>]</tt>) <strong>system_ssh_keys</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List of SSH keys to be made available on all <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the
domain. These keys are used when applications need to push code to each
other. Eg: Jenkins @see #add_domain_ssh_keys,
#remove_domain_ssh_key</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span>[<span class='object_link'><a href="SystemSshKey.html" title="SystemSshKey (class)">SystemSshKey</a></span>]</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>List of SSH keys to be made available on all <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s under the
domain. These keys are used when applications need to push code to each
other. Eg: Jenkins @see #add_domain_ssh_keys,
#remove_domain_ssh_key</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 18</span>

<span class='kw'>class</span> <span class='const'>Domain</span>
  <span class='const'>NAMESPACE_MAX_LENGTH</span> <span class='op'>=</span> <span class='int'>16</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MAX_LENGTH</span>
  <span class='const'>NAMESPACE_MIN_LENGTH</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>unless</span> <span class='kw'>defined?</span> <span class='const'>NAMESPACE_MIN_LENGTH</span>

  <span class='comment'># This is the current regex for validations for new domains
</span>  <span class='const'>DOMAIN_NAME_REGEX</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A[A-Za-z0-9]+\z</span><span class='regexp_end'>/</span></span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Timestamps</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Membership</span>

  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:canonical_namespace</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:env_vars</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Array</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:system_ssh_keys</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>SystemSshKey</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:owner</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_has_many'>has_many</span> <span class='symbol'>:applications</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='label'>dependent:</span> <span class='symbol'>:restrict</span>
  <span class='id identifier rubyid_embeds_many'>embeds_many</span> <span class='symbol'>:pending_ops</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>PendingDomainOps</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>

  <span class='id identifier rubyid_has_members'>has_members</span> <span class='label'>default_role:</span> <span class='symbol'>:admin</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:canonical_namespace</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:unique</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:owner_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># non-persisted fields used to store info about the applications in this domain
</span>  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:application_count</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:gear_counts</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:available_gears</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:max_storage_per_gear</span>  

  <span class='id identifier rubyid_validates'>validates</span> <span class='symbol'>:namespace</span><span class='comma'>,</span>
    <span class='comment'>#presence: {message: &quot;Namespace is required and cannot be blank.&quot;},
</span>    <span class='label'>format:</span>   <span class='lbrace'>{</span><span class='label'>with:</span> <span class='const'>DOMAIN_NAME_REGEX</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invalid namespace. Namespace must only contain alphanumeric characters.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>allow_nil:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>length:</span>   <span class='lbrace'>{</span><span class='label'>maximum:</span> <span class='const'>NAMESPACE_MAX_LENGTH</span><span class='comma'>,</span> <span class='label'>minimum:</span> <span class='const'>NAMESPACE_MIN_LENGTH</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be a minimum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MIN_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> and maximum of </span><span class='embexpr_beg'>#{</span><span class='const'>NAMESPACE_MAX_LENGTH</span><span class='embexpr_end'>}</span><span class='tstring_content'> characters.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>blacklisted:</span> <span class='lbrace'>{</span><span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace is not allowed.  Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_validate'>validate</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes_changed?'>allowed_gear_sizes_changed?</span>
      <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>=</span> <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_g'>g</span><span class='op'>|</span> <span class='id identifier rubyid_g'>g</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>
      <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>=</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>ApplicationContainerProxy</span><span class='period'>.</span><span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span> <span class='op'>&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='kw'>and</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='kw'>or</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span> <span class='op'>-</span> <span class='id identifier rubyid_valid_gear_sizes'>valid_gear_sizes</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span> <span class='symbol'>:allowed_gear_sizes</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The following gear sizes are invalid: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_invalid_gear_sizes'>invalid_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_to_sentence'>to_sentence</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_new_gear_sizes'>new_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
    <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
    <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
          <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_h'>h</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
        <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
        <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_before_save'>before_save</span> <span class='label'>prepend:</span> <span class='kw'>true</span> <span class='kw'>do</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_namespace'>namespace</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_has_owner?'>has_owner?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_persisted?'>persisted?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_owner_id_changed?'>owner_id_changed?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_allowed_gear_sizes'>allowed_gear_sizes</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Defend against namespace changes after creation.
</span>  <span class='id identifier rubyid_before_update'>before_update</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_namespace_changed?'>namespace_changed?</span> <span class='op'>&amp;&amp;</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid__id'>_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Domain contains applications. Delete applications first before changing the domain namespace.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>128</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Setter for domain namespace - sets the namespace and the canonical_namespace
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_namespace='>namespace=</span><span class='lparen'>(</span><span class='id identifier rubyid_domain_name'>domain_name</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_canonical_namespace'>canonical_namespace</span> <span class='op'>=</span> <span class='id identifier rubyid_domain_name'>domain_name</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='kw'>super</span>
  <span class='kw'>end</span>


  <span class='comment'># Invoke save! with a rescue for a duplicate exception
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'>#   True if the domain was saved.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
    <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

    <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
    <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
  <span class='kw'>end</span>

  <span class='comment'># Runs all jobs in &quot;init&quot; phase and stops at the first failure.
</span>  <span class='comment'>#
</span>  <span class='comment'># IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that pending_ops
</span>  <span class='comment'>#   that are inserted during a running upgrade can continue to complete.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True on success or false on failure
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
    <span class='kw'>begin</span>
      <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

        <span class='comment'># store the op._id to load it later after a reload
</span>        <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>        <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

        <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>        <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

        <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>        <span class='comment'># the op based on its position within the pending_ops list
</span>        <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
        <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
      <span class='kw'>end</span>
      <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="check_name!-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>check_name!</strong>(name) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


24
25
26
27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 24</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_name!'>check_name!</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='kw'>or</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>!~</span> <span class='const'>DOMAIN_NAME_REGEX</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>DocumentNotFound</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Domain</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sort_by_original-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>sort_by_original</strong>(user) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 79</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sort_by_original'>sort_by_original</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lambda'>lambda</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='op'>==</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span> <span class='op'>?</span> <span class='int'>0</span> <span class='op'>:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="validation_map-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>validation_map</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


75
76
77</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 75</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validation_map'>validation_map</span>
  <span class='lbrace'>{</span><span class='label'>namespace:</span> <span class='int'>106</span><span class='comma'>,</span> <span class='label'>allowed_gear_sizes:</span> <span class='int'>110</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_gear_counts-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>with_gear_counts</strong>(domains = queryable) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 83</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='id identifier rubyid_domains'>domains</span><span class='op'>=</span><span class='id identifier rubyid_queryable'>queryable</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_domains'>domains</span> <span class='op'>=</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
  <span class='id identifier rubyid_owners_by_id'>owners_by_id</span> <span class='op'>=</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:owner_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_info_by_domain'>info_by_domain</span> <span class='op'>=</span> <span class='const'>Application</span><span class='period'>.</span><span class='id identifier rubyid_in'>in</span><span class='lparen'>(</span><span class='label'>domain_id:</span> <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='period'>.</span><span class='id identifier rubyid_group_by'>group_by</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>domain_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_domains'>domains</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='id identifier rubyid_info_by_domain'>info_by_domain</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
        <span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>gears</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_size'>size</span><span class='comma'>,</span><span class='id identifier rubyid_count'>count</span><span class='op'>|</span>
          <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
          <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_size'>size</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='id identifier rubyid_count'>count</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_h'>h</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_application_count'>application_count</span> <span class='op'>=</span> <span class='int'>0</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_gear_counts'>gear_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_owner'>owner</span> <span class='op'>=</span> <span class='id identifier rubyid_owners_by_id'>owners_by_id</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_available_gears'>available_gears</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_gears'>max_gears</span> <span class='op'>-</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_consumed_gears'>consumed_gears</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_max_storage_per_gear'>max_storage_per_gear</span> <span class='op'>=</span> <span class='id identifier rubyid_owner'>owner</span><span class='period'>.</span><span class='id identifier rubyid_max_storage'>max_storage</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_env_variables-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>add_env_variables</strong>(variables, skip_node_ops = false) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 175</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_env_variables'>add_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_new_var'>new_var</span><span class='op'>|</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cur_var'>cur_var</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='id identifier rubyid_new_var'>new_var</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_cur_var'>cur_var</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>  <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
  <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

  <span class='comment'># if this is an update to an existing environment variable, remove the previous ones
</span>  <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_env_vars_to_rm'>env_vars_to_rm</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_system_ssh_keys-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>add_system_ssh_keys</strong>(ssh_keys, skip_node_ops = false) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 150</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_system_ssh_keys'>add_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>  <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :add_domain_ssh_keys, arguments: { &quot;keys_attrs&quot; =&gt; keys_attrs }, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>  <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>AddSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
  <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pushAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="inherit_membership-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>inherit_membership</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


146
147
148</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 146</span>

<span class='kw'>def</span> <span class='id identifier rubyid_inherit_membership'>inherit_membership</span>
  <span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="members_changed-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>members_changed</strong>(added, removed, changed_roles) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


207
208
209
210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 207</span>

<span class='kw'>def</span> <span class='id identifier rubyid_members_changed'>members_changed</span><span class='lparen'>(</span><span class='id identifier rubyid_added'>added</span><span class='comma'>,</span> <span class='id identifier rubyid_removed'>removed</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>ChangeMembersDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>members_added:</span> <span class='id identifier rubyid_added'>added</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>members_removed:</span> <span class='id identifier rubyid_removed'>removed</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='comma'>,</span> <span class='label'>roles_changed:</span> <span class='id identifier rubyid_changed_roles'>changed_roles</span><span class='period'>.</span><span class='id identifier rubyid_presence'>presence</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_pending_op'>pending_op</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_env_variables-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>remove_env_variables</strong>(remove_key, skip_node_ops = false) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197
198
199
200
201
202
203
204
205</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 194</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_env_variables'>remove_env_variables</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
    <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_variables'>variables</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_env_vars'>env_vars</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_env'>env</span><span class='op'>|</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>component_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='op'>==</span><span class='id identifier rubyid_remove_key'>remove_key</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_variables'>variables</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :remove_env_variables, arguments: {&quot;variables&quot; =&gt; variables}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>  <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveEnvVarsDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>variables:</span> <span class='id identifier rubyid_variables'>variables</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
  <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>env_vars:</span> <span class='id identifier rubyid_variables'>variables</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_system_ssh_keys-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>remove_system_ssh_keys</strong>(remove_key, skip_node_ops = false) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 159</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_system_ssh_keys'>remove_system_ssh_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_remove_key'>remove_key</span><span class='comma'>,</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
    <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_key'>remove_key</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_system_ssh_keys'>system_ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>component_id:</span> <span class='id identifier rubyid_remove_key'>remove_key</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_ssh_keys'>ssh_keys</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='comment'>#keys_attrs = ssh_keys.map{|k| k.attributes.dup}
</span>  <span class='comment'>#pending_op = PendingDomainOps.new(op_type: :delete_domain_ssh_keys, arguments: {&quot;keys_attrs&quot; =&gt; keys_attrs}, on_apps: applications, created_at: Time.now, state: &quot;init&quot;)
</span>  <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='op'>=</span> <span class='id identifier rubyid_ssh_keys'>ssh_keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_key_hash'>to_key_hash</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span> <span class='op'>=</span> <span class='const'>RemoveSystemSshKeysDomainOp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>keys_attrs:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span><span class='comma'>,</span> <span class='label'>on_apps:</span> <span class='id identifier rubyid_applications'>applications</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span>
  <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update_all'>update_all</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$push</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>pending_ops:</span> <span class='id identifier rubyid_pending_op'>pending_op</span><span class='period'>.</span><span class='id identifier rubyid_serializable_hash_with_timestamp'>serializable_hash_with_timestamp</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$pullAll</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>system_ssh_keys:</span> <span class='id identifier rubyid_keys_attrs'>keys_attrs</span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_jobs-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>run_jobs</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Runs all jobs in “init” phase and stops at the first failure.</p>

<p>IMPORTANT: When changing jobs, be sure to leave old jobs runnable so that
pending_ops</p>

<pre class="code ruby"><code class="ruby">that are inserted during a running upgrade can continue to complete.</code></pre>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>True on success or false on failure</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 219</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_jobs'>run_jobs</span>
  <span class='kw'>begin</span>
    <span class='kw'>while</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>state:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

      <span class='comment'># store the op._id to load it later after a reload
</span>      <span class='comment'># this is required to prevent a reload from replacing it with another one based on position
</span>      <span class='id identifier rubyid_op_id'>op_id</span> <span class='op'>=</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span>

      <span class='comment'># try to do an update on the pending_op state and continue ONLY if successful
</span>      <span class='id identifier rubyid_op_index'>op_index</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>._id</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>init</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_ops.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_op_index'>op_index</span><span class='embexpr_end'>}</span><span class='tstring_content'>.state</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>queued</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rparen'>)</span>

      <span class='kw'>unless</span> <span class='id identifier rubyid_retval'>retval</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>updatedExisting</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_skip_node_ops'>skip_node_ops</span><span class='rparen'>)</span>

      <span class='comment'># reloading the op reloads the domain and then incorrectly reloads (potentially)
</span>      <span class='comment'># the op based on its position within the pending_ops list
</span>      <span class='comment'># hence, reloading the domain, and then fetching the op using the op_id stored earlier
</span>      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
      <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_ops'>pending_ops</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_op_id'>op_id</span><span class='rparen'>)</span>

      <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_close_op'>close_op</span>
      <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_op'>op</span><span class='period'>.</span><span class='id identifier rubyid_completed?'>completed?</span>
    <span class='kw'>end</span>
    <span class='kw'>true</span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="save_with_duplicate_check!-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>save_with_duplicate_check!</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Invoke save! with a rescue for a duplicate exception</p>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<pre class="code ruby"><code class="ruby">True if the domain was saved.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


139
140
141
142
143
144</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 139</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_with_duplicate_check!'>save_with_duplicate_check!</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>OpenShift</span><span class='op'>::</span><span class='const'>UserException</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_namespace'>namespace</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; is already in use. Please choose another.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>103</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>11000</span><span class='comma'>,</span> <span class='int'>11001</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_details'>details</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>code</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_gear_counts-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>with_gear_counts</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/domain.rb', line 110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_with_gear_counts'>with_gear_counts</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='kw'>self</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Sep 27 22:05:48 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-2.0.0).
</div>

  </body>
</html>