<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Lock
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (L)</a> &raquo;
    
    
    <span class="title">Lock</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Lock
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Lock</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Mongoid::Document</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/home/fedora/origin-server/controller/app/models/lock.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Represents a lock object for a <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> and <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that it owns</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#apps-instance_method" title="#apps (instance method)">- (Object) <strong>apps</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked-instance_method" title="#locked (instance method)">- (Boolean) <strong>locked</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Representing if the user is locked.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#user-instance_method" title="#user (instance method)">- (CloudUser) <strong>user</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Owner of the lock.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_lock-class_method" title="create_lock (class method)">+ (Object) <strong>create_lock</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete_lock-class_method" title="delete_lock (class method)">+ (Object) <strong>delete_lock</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock_application-class_method" title="lock_application (class method)">+ (Object) <strong>lock_application</strong>(application, timeout = 1800) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to lock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock_user-class_method" title="lock_user (class method)">+ (Object) <strong>lock_user</strong>(user, app, timeout = 1800) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock_application-class_method" title="unlock_application (class method)">+ (Object) <strong>unlock_application</strong>(application) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to unlock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock_user-class_method" title="unlock_user (class method)">+ (Object) <strong>unlock_user</strong>(user, app) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to unlock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="apps-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>apps</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>List of <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s that are locked</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 8</span>

<span class='kw'>class</span> <span class='const'>Lock</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:locked</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Boolean</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:timeout</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:app_ids</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Hash</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.
</span>  <span class='comment'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_lock'>create_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_delete_lock'>delete_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock the {CloudUser}. 
</span>  <span class='comment'># NOTE: User lock is available only for user apps with application lock.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_user'>lock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:timeout</span><span class='period'>.</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>locked:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock the {CloudUser}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_user'>unlock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>locked</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.
</span>  <span class='comment'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_application'>lock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$lt</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to obtain lock for application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock an {Application}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_application'>unlock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$unset</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to unlock application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="locked-instance_method">
  
    - (<tt>Boolean</tt>) <strong>locked</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Representing if the user is locked</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>representing if the user is locked</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 8</span>

<span class='kw'>class</span> <span class='const'>Lock</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:locked</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Boolean</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:timeout</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:app_ids</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Hash</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.
</span>  <span class='comment'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_lock'>create_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_delete_lock'>delete_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock the {CloudUser}. 
</span>  <span class='comment'># NOTE: User lock is available only for user apps with application lock.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_user'>lock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:timeout</span><span class='period'>.</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>locked:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock the {CloudUser}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_user'>unlock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>locked</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.
</span>  <span class='comment'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_application'>lock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$lt</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to obtain lock for application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock an {Application}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_application'>unlock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$unset</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to unlock application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="user-instance_method">
  
    - (<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>) <strong>user</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Owner of the lock</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>owner of the lock</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 8</span>

<span class='kw'>class</span> <span class='const'>Lock</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span>

  <span class='id identifier rubyid_belongs_to'>belongs_to</span> <span class='symbol'>:user</span><span class='comma'>,</span> <span class='label'>class_name:</span> <span class='const'>CloudUser</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:locked</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Boolean</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:timeout</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>0</span>
  <span class='id identifier rubyid_field'>field</span> <span class='symbol'>:app_ids</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Hash</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_create_indexes'>create_indexes</span>

  <span class='comment'># Attempts to lock the {CloudUser}. Once locked, no other threads can obtain a lock on the {CloudUser} or any owned {Application}s.
</span>  <span class='comment'># This lock is denied if any of the {Application}s owned by the {CloudUser} are currently locked.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_lock'>create_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_delete_lock'>delete_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock the {CloudUser}. 
</span>  <span class='comment'># NOTE: User lock is available only for user apps with application lock.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_user'>lock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:timeout</span><span class='period'>.</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>locked:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock the {CloudUser}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># user::
</span>  <span class='comment'>#   The {CloudUser} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_user'>unlock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>locked</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to lock an {Application}. Once locked, no other threads can obtain a lock on the {Application} or the {CloudUser} that owns it.
</span>  <span class='comment'># This lock is denied if the owning {CloudUser} is locked or the {Application} has been locked by another thread.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to lock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the lock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_application'>lock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$lt</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to obtain lock for application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Attempts to unlock an {Application}.
</span>  <span class='comment'>#
</span>  <span class='comment'># == Parameters:
</span>  <span class='comment'># application::
</span>  <span class='comment'>#   The {Application} to attempt to unlock
</span>  <span class='comment'>#
</span>  <span class='comment'># == Returns:
</span>  <span class='comment'># True if the unlock was successful.
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_application'>unlock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>      <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>      <span class='comment'># If domain is nil, try to load the domain from the primary
</span>      <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$unset</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to unlock application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="create_lock-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>create_lock</strong>(user) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>. Once locked, no other threads can obtain
a lock on the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> or any owned <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s. This lock is denied
if any of the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>s owned by the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> are currently locked.</p>

<h2 id="label-Parameters%3A">Parameters:<span><a href="#label-Parameters%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>
<dl class="rdoc-list note-list"><dt>user
<dd>
<p>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> to attempt to lock</p>
</dd></dl>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>True if the lock was successful.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 29</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_lock'>create_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="delete_lock-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>delete_lock</strong>(user) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 33</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_delete_lock'>delete_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_application-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>lock_application</strong>(application, timeout = 1800) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to lock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>. Once locked, no other threads can obtain
a lock on the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> or the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> that owns it. This lock is
denied if the owning <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> is locked or the <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> has been
locked by another thread.</p>

<h2 id="label-Parameters%3A">Parameters:<span><a href="#label-Parameters%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>
<dl class="rdoc-list note-list"><dt>application
<dd>
<p>The <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> to attempt to lock</p>
</dd></dl>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>True if the lock was successful.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 80</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_application'>lock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>    <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>    <span class='comment'># If domain is nil, try to load the domain from the primary
</span>    <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$lt</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbrace'>}</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to obtain lock for application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_user-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>lock_user</strong>(user, app, timeout = 1800) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to lock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.  NOTE: User lock is available only for
user apps with application lock.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41
42
43
44
45
46
47
48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 39</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock_user'>lock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='op'>=</span><span class='int'>1800</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_find_or_create_by'>find_or_create_by</span><span class='lparen'>(</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$or</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='symbol'>:timeout</span><span class='period'>.</span><span class='id identifier rubyid_lt'>lt</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>locked:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock_application-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>unlock_application</strong>(application) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to unlock an <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span>.</p>

<h2 id="label-Parameters%3A">Parameters:<span><a href="#label-Parameters%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>
<dl class="rdoc-list note-list"><dt>application
<dd>
<p>The <span class='object_link'><a href="Application.html" title="Application (class)">Application</a></span> to attempt to unlock</p>
</dd></dl>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>True if the unlock was successful.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 112</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_application'>unlock_application</span><span class='lparen'>(</span><span class='id identifier rubyid_application'>application</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='comment'># application.domain can be nil if the application is being created immediately after domain creation
</span>    <span class='comment'># If the domain is being read from the secondary, it may not be present
</span>    <span class='comment'># If domain is nil, try to load the domain from the primary
</span>    <span class='comment'># Note: If there is a way to load the domain relationship from the primary, we should do that 
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='const'>Domain</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>_id:</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain_id'>domain_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_owner_id'>owner_id</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_app_id'>app_id</span> <span class='op'>=</span> <span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$unset</span><span class='tstring_end'>&quot;</span></span><span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_id'>app_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to unlock application </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock_user-class_method">
  
    + (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>unlock_user</strong>(user, app) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to unlock the <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span>.</p>

<h2 id="label-Parameters%3A">Parameters:<span><a href="#label-Parameters%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>
<dl class="rdoc-list note-list"><dt>user
<dd>
<p>The <span class='object_link'><a href="CloudUser.html" title="CloudUser (class)">CloudUser</a></span> to attempt to unlock</p>
</dd></dl>

<h2 id="label-Returns%3A">Returns:<span><a href="#label-Returns%3A">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>True if the unlock was successful.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/fedora/origin-server/controller/app/models/lock.rb', line 60</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_unlock_user'>unlock_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_app'>app</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='comma'>,</span> <span class='symbol'>:locked</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>app_ids.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app'>app</span><span class='period'>.</span><span class='id identifier rubyid__id'>_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$exists</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_updates'>updates</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>locked</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Lock</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_and_modify'>find_and_modify</span><span class='lparen'>(</span><span class='id identifier rubyid_updates'>updates</span><span class='comma'>,</span> <span class='label'>new:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Moped</span><span class='op'>::</span><span class='const'>Errors</span><span class='op'>::</span><span class='const'>OperationFailure</span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Sep 25 22:05:37 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-2.0.0).
</div>

  </body>
</html>