<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="Asciidoctor 0.1.4" name="generator">
<meta content="OpenShift Origin Documentation Project &lt;dev@lists.openshift.redhat.com&gt;" name="author">
<title>OpenShift PEP 003: Scheduling of Broker Jobs</title>
<style>@import url(http://openshift.redhat.com/app/assets/overpass.css);
@import url(http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/*
Origin theme source file

To build it:
- clone the asciidoctor-stylesheet-factory repo
- copy this theme file to the sass folder inside the repo
- copy the settings file to the sass/settings file inside the repo
- cd to the cloned repo
- bundle install
- compass compile
- compiled stylesheet is in the stylesheets/ directory
*/
/* Generated by Font Squirrel (http://www.fontsquirrel.com) on July 24, 2013 */
@font-face { font-family: 'source_code_pro'; src: url("fonts/sourcecodepro-regular-webfont.eot"); src: url("fonts/sourcecodepro-regular-webfont.eot?#iefix") format("embedded-opentype"), url("fonts/sourcecodepro-regular-webfont.woff") format("woff"), url("fonts/sourcecodepro-regular-webfont.ttf") format("truetype"), url("sourcecodepro-regular-webfont.svg#source_code_proregular") format("svg"); font-weight: normal; font-style: normal; }

/*
Settings and overrides for the Origin theme
*/
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title, .tableblock > caption { line-height: 1.4; color: #6f6f6f; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #006699; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #005580; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Overpass, sans-serif; font-weight: bold; font-style: normal; color: #222222; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #6f6f6f; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #7f0a0c; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }

blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

/*
.clearfix,
.floatend { zoom: 1; &:before, &:after { content: " "; display: table; } &:after { clear: both; }
}
*/
code { font-size: inherit; padding: 0; white-space: nowrap; background-color: inherit; border: 0 solid #dddddd; -webkit-border-radius: 0; border-radius: 0; text-shadow: none; }

kbd.keyseq { color: #555555; }

kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #090909; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: #222222; font-weight: bold; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.25em; }
#toc > ul, #toc > ol { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a, #toc ol.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1, #toc ol.sectlevel0 ol.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul, #toc ol { list-style-type: none; }

#toctitle { color: #6f6f6f; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul, #toc.toc2 > ol { font-size: .95em; }
  #toc.toc2 ul ul, #toc.toc2 ol ol { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1, #toc.toc2 ol.sectlevel0 ol.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }

#footer-text { color: #dddddd; line-height: 1.44; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #222222; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #151515; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > .paragraph:last-child > p { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #6f6f6f; margin-top: 0; line-height: 1.6; }
.sidebarblock > .content > .paragraph:last-child p { margin-bottom: 0; }

pre { color: black; font-family: source_code_pro, monospace, serif; overflow-x: auto; line-height: 1.4; }

.verseblock { margin-bottom: 1.25em; }

.literalblock, .listingblock { margin-bottom: 1.25em; }
.literalblock > .content > pre, .listingblock > .content > pre { background: #eeeeee; color: black; font-family: source_code_pro, monospace, serif; border-width: 0; padding: 0.8em 0.8em 0.6em 0.8em; word-wrap: break-word; line-height: 1.4; }
.literalblock > .content > pre.nowrap, .listingblock > .content > pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content > pre > code, .listingblock > .content > pre > code { font-size: 1em; white-space: inherit; color: black; font-family: source_code_pro, monospace, serif; padding: 0; background: none; font-weight: normal; border: none; }
@media only screen { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 1em; } }

.listingblock:hover .xml:before { content: "xml"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .html:before { content: "html"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .ruby:before { content: "ruby"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .asciidoc:before { content: "asciidoc"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .java:before { content: "java"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .javascript:before { content: "javascript"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .css:before { content: "css"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .scss:before { content: "scss"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }

.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 0; border-radius: 0; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.halign-top, td.tableblock.halign-top { vertical-align: top; }

th.tableblock.halign-bottom, td.tableblock.halign-bottom { vertical-align: bottom; }

th.tableblock.halign-middle, td.tableblock.halign-middle { vertical-align: middle; }

p.tableblock.header { color: #222222; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist { list-style-type: none; margin-left: 0.625em; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

td.hdlist1 { vertical-align: top; padding-right: .8em; font-weight: bold; }

.qanda > ol > li > p:first-child { color: #005580; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: none; box-shadow: none; }

.imageblock { margin-bottom: 1.25em; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding: 0.75em 0.375em; margin-bottom: 1.25em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: none; cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #006699; color: #004c73; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

nav.global { background: #222; width: 100%; height: 4em; }
nav.global ul { list-style-type: none; margin: 0; }
nav.global li { display: inline-block; }
nav.global a { display: block; padding: .5em 1em; font-family: Overpass; font-size: 1.1em; color: white; }
nav.global a:hover { color: #ef2e32; }
nav.global a img { margin-top: .25em; height: 2.75em; }

#header > h1 { border: none; }

#toc { background: #eee; border-right: none; }
#toc.toc2 { box-shadow: 1px 0 1px rgba(0, 0, 0, 0.3); }

code { font-family: source_code_pro; }

.admonitionblock td.icon .icon-tip:before { color: #cc6; text-shadow: none; }

#footer { background-image: url("images/panda.png"); background-position: right bottom; background-repeat: no-repeat; }

/* Alignment Styles */
.halign-left { text-align: left }
.halign-center { text-align: center }
.halign-right { text-align: right }

.valign-top { vertical-align: top }
.valign-middle { vertical-align: middle }
.valign-bottom { vertical-align: bottom }</style>
<link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="article toc2">
<nav class="global">
<ul>
<li>
<a href="http://openshift.github.io">
<img alt="OpenShift Origin" src="images/logo.png">
</a>
</li>
<li>
<a href="index.html">Documentation Home</a>
</li>
</ul>
</nav>
<div id="header">
<h1>OpenShift PEP 003: Scheduling of Broker Jobs</h1>
<span id="author">OpenShift Origin Documentation Project &lt;dev@lists.openshift.redhat.com&gt;</span>
<br>
<div class="toc2" id="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#specification">Specification</a></li>
<li><a href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a href="#rationale">Rationale</a></li>
<li><a href="#faqs">FAQs</a></li>
</ul>
</div>
</div>
<div id="content"><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>PEP: 3<br>
Title: Scheduling of Broker Jobs<br>
Status: reviewed<br>
Author: Dan McPherson <a href="mailto:dmcphers@redhat.com">dmcphers@redhat.com</a>, Abhishek Gupta <a href="mailto:abhgupta@redhat.com">abhgupta@redhat.com</a>, Jordan Liggitt <a href="mailto:jliggitt@redhat.com">jliggitt@redhat.com</a> Arch Priority: medium<br>
Complexity: 100<br>
Affected Components: web, api, broker, cli<br>
Affected Teams: UI 40, Broker 40<br>
User Impact: medium<br>
Epic:</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="abstract"><a class="anchor" href="#abstract"></a>Abstract</h3>
<div class="paragraph">
<p>Today in OpenShift, every operation that goes through the broker is executed immediately. Adding a scheduler will change any potentially long running processes (anything involving node operations) to involve multiple API calls. A first call to launch the task (such as create app) and secondary calls to check the status of the associated job(s). Clients may choose to hide these requests behind a spinner/progress bar, or they might want to indicate to the user the job has been queued and have the user check the status amongst all of their jobs. The major advantage of the latter being an immediate response to the user allowing them to move on within the client.</p>
</div>
</div>
<div class="sect2">
<h3 id="motivation"><a class="anchor" href="#motivation"></a>Motivation</h3>
<div class="paragraph">
<p>OpenShift has numerous tasks that take multiple seconds and even minutes (create application, add cartridge, scale up, etc). The user experience for these requests today is unpredictable and not really suitable for web requests. In addition, some operations may be blocked by concurrent operations already happening in the system (Ex: concurrent create app and delete from an impatient user).</p>
</div>
<div class="paragraph">
<p>The goal of adding a scheduler is to accomplish these long running jobs reliably in the background and allow the user to see the status of existing jobs.</p>
</div>
</div>
<div class="sect2">
<h3 id="specification"><a class="anchor" href="#specification"></a>Specification</h3>
<div class="sect3">
<h4 id="today-the-process-for-create-application-looks-like"><a class="anchor" href="#today-the-process-for-create-application-looks-like"></a>Today the process for create application looks like:</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User clicks a button in the web UI/CLI/IDE to create an application</p>
</li>
<li>
<p>REST API request is made to create the app</p>
</li>
<li>
<p>A series of operations happen on the broker and nodes to create the app</p>
</li>
<li>
<p>REST API response is returned to the caller with the result</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="adding-a-scheduler-will-change-this-process-to-be"><a class="anchor" href="#adding-a-scheduler-will-change-this-process-to-be"></a>Adding a scheduler will change this process to be:</h4>
<div class="sect4">
<h5 id="from-the-perspective-of-the-client"><a class="anchor" href="#from-the-perspective-of-the-client"></a>From the perspective of the client:</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User clicks a button in the web UI/CLI/IDE to create an application</p>
</li>
<li>
<p>REST API request is made to create the app</p>
</li>
<li>
<p>An entry is added to the broker&#8217;s datastore indicating the job&#8217;s details and a job is queued in the scheduler referencing back to the broker&#8217;s job details</p>
</li>
<li>
<p>REST API responds with identifier for the job</p>
</li>
<li>
<p>Client can choose to show status for the job (in_progress, waiting, complete, failed)</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="from-the-perspective-of-the-scheduler"><a class="anchor" href="#from-the-perspective-of-the-scheduler"></a>From the perspective of the scheduler</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A high level job is queued (create app) from step 2 above</p>
</li>
<li>
<p>The scheduler gets to the job and asks a broker worker to execute create app above and elaborates the high level job.</p>
</li>
<li>
<p>The broker worker elaborates the job into a series of smaller steps that can be retried or rolled back. These elaborated steps are stored in the broker&#8217;s datastore.</p>
</li>
<li>
<p>Each of the elaborated jobs are executed and marked as complete. Failures are retried as appropriate.</p>
</li>
<li>
<p>Completed jobs are marked accordingly and pruned of elaborated steps. Consistently failed jobs are logged with an opportunity for admin intervention.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="technology-choices"><a class="anchor" href="#technology-choices"></a>Technology Choices:</h4>
<div class="ulist">
<ul>
<li>
<p>Our favored scheduling technology is beanstalkd: <a href="http://kr.github.com/beanstalkd/">http://kr.github.com/beanstalkd/</a></p>
</li>
<li>
<p>Pros: Light weight, Highest performance, Decent UI, Good code style, Best operational characteristics(Process monitoring, Automatic HA, Already available in RHEL)</p>
</li>
<li>
<p>Cons: Concerns over memory leaks</p>
</li>
<li>
<p>Along with the backburner gem: <a href="https://github.com/nesquena/backburner">https://github.com/nesquena/backburner</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="implementation-details"><a class="anchor" href="#implementation-details"></a>Implementation Details:</h4>
<div class="sect4">
<h5 id="pre-requisites"><a class="anchor" href="#pre-requisites"></a>Pre-requisites</h5>
<div class="paragraph">
<p>Prior to the scheduler implementation, the sub-ops will be converted to using their own sub-classes to allow them to manage/dictate their own retry and rollback mechanisms. A separate trello card already exists to capture the details of this effort: <a href="https://trello.com/c/ZaRSiGj4/40-subclass-pendingops-for-each-op-type">https://trello.com/c/ZaRSiGj4/40-subclass-pendingops-for-each-op-type</a></p>
</div>
</div>
<div class="sect4">
<h5 id="setup"><a class="anchor" href="#setup"></a>Setup</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The scheduler will be implemented using beanstalkd</p>
</li>
<li>
<p>A separate instance of the scheduler will be running on each broker machine</p>
</li>
<li>
<p>Beanstalkd will be run in persistent mode to persist the jobs to file on disk</p>
</li>
<li>
<p>The worker clients will be implemented using backburner or beaneater (client choice TBD based on prototyping results)</p>
</li>
<li>
<p>Multiple workers will be spawned on each broker machine to process the jobs from the scheduler queues</p>
</li>
<li>
<p>The workers will load the broker Rails environment</p>
</li>
<li>
<p>Workers will process jobs from one or more queues of the scheduler</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="adding-jobs-to-the-scheduler"><a class="anchor" href="#adding-jobs-to-the-scheduler"></a>Adding Jobs to the Scheduler</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Jobs corresponding to REST API requests coming to a particular broker will be added to the scheduler specific to that broker</p>
</li>
<li>
<p>The job will be added to the scheduler queue right after the pending op is added to mongo for the application/domain/user</p>
</li>
<li>
<p>After adding a job to the scheduler, the field job_creation_status in the pending op document is set to <em>scheduled</em> to indicate that the job has been added to the scheduler</p>
<div class="ulist">
<ul>
<li>
<p>This will be a new field in the pending op embedded document</p>
</li>
</ul>
</div>
</li>
<li>
<p>Any new user request coming in will make a check to see if there are any pending ops without the flag set to <em>scheduled</em></p>
<div class="ulist">
<ul>
<li>
<p>If so, then corresponding jobs will be added to the scheduler and the field set to <em>scheduled</em></p>
</li>
</ul>
</div>
</li>
<li>
<p>Additionally, the admin script to clear the pending ops will also check for such pending ops and create jobs, if required</p>
<div class="ulist">
<ul>
<li>
<p>The admin script oo-admin-clear-pending-ops will have to be renamed ( new name: <strong>TBD</strong> )</p>
</li>
<li>
<p>A cron job will need to be created to schedule the script to run at regular intervals ( <strong>TBD</strong>: 10, 30, or 60 minutes? )</p>
</li>
</ul>
</div>
</li>
<li>
<p>The fallback mechanisms helps us avoid having to over-engineer the scheduler design for handling corner cases</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="job-processing"><a class="anchor" href="#job-processing"></a>Job Processing</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A job_status document will be created in a separate collection in mongo</p>
</li>
<li>
<p>The job_status document will also keep tab of child/linked/dependent jobs</p>
<div class="ulist">
<ul>
<li>
<p>In case of domain/user jobs, this list will contain IDs of job_status corresponding to pending ops on applications</p>
</li>
<li>
<p>In case of jenkins application creation, this list will contain IDs of job_status corresponding to pending ops on applications to create environment variables and adding ssh keys</p>
</li>
</ul>
</div>
</li>
<li>
<p>The job added to the scheduler will consist of ONLY the application/domain/user ID and not the ID for the pending operation</p>
</li>
<li>
<p>The workers will "reserve" a job to work on and execute the first pending operation within the application/domain/user</p>
<div class="ulist">
<ul>
<li>
<p>This will ensure that out of order execution of pending ops does not take place</p>
</li>
</ul>
</div>
</li>
<li>
<p>Upon completion of the pending op:</p>
<div class="ulist">
<ul>
<li>
<p>The job will be removed from the scheduler queue</p>
</li>
<li>
<p>The result for the operation will be updated in the job_status document and its state will be updated as well</p>
</li>
<li>
<p>The pending op will be removed from mongo from the applications/domains/cloud_users collection</p>
</li>
</ul>
</div>
</li>
<li>
<p>The workers are killed/recycled after a certain number of job completions</p>
<div class="ulist">
<ul>
<li>
<p>This number of job completions is configurable</p>
</li>
<li>
<p>This avoids issues of memory leaks with long running worker processes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="failure-scenarios"><a class="anchor" href="#failure-scenarios"></a>Failure Scenarios:</h5>
<div id="what-happens-if-the-scheduler-goes-down" class="paragraph">
<p>What happens if the scheduler goes down?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It will be respun by a watcher process</p>
</li>
<li>
<p>All persisted jobs that the scheduler was handling before dying will be reloaded from the file on disk</p>
</li>
<li>
<p>Any jobs that were not added to the scheduler or not yet persisted, will be picked up by the oo-admin-clear-pending-ops script on its next run</p>
</li>
<li>
<p>The oo-admin-clear-pending-ops script will be run at regular intervals and will pick up any jobs that are older than an a certain time limit ( <strong>TBD</strong>: 10, 30, 60 minutes? )</p>
</li>
<li>
<p>We will assume that this time limit is sufficient for the workers to get to a pending op and start executing it as part of regular operation</p>
</li>
<li>
<p>If the worker tries to execute the application job and finds no ops, it will simply mark it job complete and delete it from the queue</p>
</li>
<li>
<p>Workers will be resilient and will keep retrying connection to the scheduler</p>
</li>
</ul>
</div>
<div id="what-happens-if-worker-process-dies" class="paragraph">
<p>What happens if worker process dies?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A moritoring script/utility (will be created) to re-spawn workers</p>
</li>
<li>
<p>The in-progress pending op will be placed back in the queue after the job timeout</p>
</li>
<li>
<p>In order to prevent requiring a large job timeout, the worker will frequently "touch" the job to renew the timeout (after every sub-op completion)</p>
</li>
</ul>
</div>
<div id="what-happens-if-the-job-fails" class="paragraph">
<p>What happens if the job fails?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The failed pending op will be retried once immediately</p>
</li>
<li>
<p>If the retry attempt fails, the job will be added to the scheduler specifying a delay (job delay is beanstalkd functionality)</p>
</li>
<li>
<p>The job delay will be calculated as follows:</p>
</li>
<li>
<p>each sub-op will specify its own retry delay in seconds</p>
</li>
<li>
<p>the actual delay for a particular retry attempt will be the retry delay multiplied by the retry attempt</p>
</li>
<li>
<p>delay = retry_delay * retry_count (retry attempts already made)</p>
</li>
<li>
<p>The retry_count for the sub-ops will be incremented to indicate the number of retries already performed</p>
</li>
<li>
<p>Each sub-op will specify its re-execution requiremcents, and they could be one of the following:</p>
</li>
<li>
<p>it could be re-executed/retried as-is without worrying about the state of the previous attempt</p>
</li>
<li>
<p>it could specify that the failed sub-op be first rolledback before retrying it</p>
</li>
<li>
<p>it could specify a list of earlier sub-ops (an array of sub-op IDs) that will need to be rolled back (along with any sub-ops that depend on them) before they can all be re-attempted</p>
</li>
<li>
<p>During a retry attempt, first any specified sub-ops are rolled back before retrying the pending op again</p>
</li>
<li>
<p>Each sub-op could fail a few times (as long as it is less than the retry limit for the sub-op) before being successfully executed and the pending op execution would continue</p>
</li>
<li>
<p>The admin script to clear the pending ops will also look at failed pending ops that haven&#8217;t exhausted the retry limit and have not been updated for longer than the retry delay (based on the retry count) + 10 minutes (this delay is to allow the workers to get to the job)</p>
</li>
<li>
<p>If it finds any pending ops that fit the criteria, it adds jobs to the scheduler for them</p>
</li>
</ul>
</div>
<div id="what-happens-if-the-job-fails-even-after-all-retry-attempts" class="paragraph">
<p>What happens if the job fails even after all retry attempts?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Upon the failure of the last retry attempt, it will be rolled back immediately</p>
</li>
<li>
<p>In case of failure to rollback, the pending op rollback will be retried a fixed number of times</p>
</li>
<li>
<p>The number of retries are specified by each sub-op and managed at the sub-op level</p>
</li>
<li>
<p>Each sub-op could fail a few times (as long as it is less than the rollback retry limit for the sub-op) before being successfully rolled back and the pending op rollback operation would continue</p>
</li>
<li>
<p>A new field rollback_retry_count will be added to the sub-ops to indicate the number of retries already performed</p>
</li>
<li>
<p>A job will be added to the scheduler specifying a certain retry delay (job delay is beanstalkd functionality)</p>
</li>
<li>
<p>The rollback retry delay will be calculated in the same way as the retry delay for the sub-op</p>
</li>
<li>
<p>The admin script to clear the pending ops will also look at failed pending ops that haven&#8217;t exhausted the rollback retry limit and have not been updated for longer than the rollback retry delay (based on rollback retry count) + 10 minutes (this delay is to allow the workers to get to the job)</p>
</li>
<li>
<p>If it finds any pending ops that fit the criteria, it adds jobs to the scheduler for them</p>
</li>
</ul>
</div>
<div id="what-happens-if-the-rollback-fails-for-a-pending-op-and-it-gets-stuck" class="paragraph">
<p>What happens if the rollback fails for a pending op and it gets stuck?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A failed pending op that is stuck blocks the execution of any subsequent pending ops for that user/domain/application</p>
</li>
<li>
<p>We will not skip a failed job as we want to ensure that out-of-order execution of pending ops does not happen</p>
</li>
<li>
<p>We will continue to queue up additional pending ops based on user requests upto a certain limit</p>
</li>
<li>
<p>Once a certain number (configurable) of pending ops are already present, we will no longer create additional pending ops and return an error to the user instead</p>
</li>
<li>
<p>The admin script to clear pending ops (to be renamed) will also highlight failed jobs in its output</p>
</li>
</ul>
</div>
<div id="what-happens-if-a-worker-gets-a-job-for-an-applicationdomainuser-with-a-failedstuck-job" class="paragraph">
<p>What happens if a worker gets a job for an application/domain/user with a failed/stuck job?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The worker will pick up the pending op and look at its retry_count as well as last update time</p>
</li>
<li>
<p>If the retry_count is less than the retry limit for the pending op AND the time since the pending op last update is more than the retry delay, then the job is retried, else the job is skipped and removed from the scheduler queue</p>
</li>
<li>
<p>If the retry limit is reached and the job is still stuck, no further action is taken and manual intervention will be required by Ops/Admin</p>
</li>
<li>
<p>If the retry attempts succeed in executing/rolling back the pending op, then jobs corresponding to any existing pending ops in the queue are added to the scheduler</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="job-status"><a class="anchor" href="#job-status"></a>Job Status:</h5>
<div class="ulist">
<ul>
<li>
<p>The job status will be stored in a separate collection in mongo</p>
</li>
<li>
<p>To get the exact state, the pending op in the user/domain/application object will be queried</p>
</li>
<li>
<p>In case linked/child jobs are present, they will be queried to determine the job state</p>
</li>
<li>
<p>This will be done by the broker and will need to be very fast</p>
</li>
<li>
<p>The broker can get all the child jobs for a given job in a single shot from mongo</p>
</li>
<li>
<p>If a job_status document is not created/added, then one is created/added when the worker finishes the job and has to save/store the job status</p>
</li>
</ul>
</div>
<div id="job-status-attributes" class="paragraph">
<p>Job Status Attributes</p>
</div>
<div class="paragraph">
<p>The job status will contain the following fields in the response to the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>job_id: identifier of the corresponding job</p>
</li>
<li>
<p>This will be the ID of the pending op within application/domain/user document</p>
</li>
<li>
<p>type: [ "create_app" | "add_component" | "start_app" | etc ]</p>
</li>
<li>
<p>title: job title in sentence text (eg: Create application <em>xyz</em>)</p>
</li>
<li>
<p>description: Job details or currently running steps in sentence text</p>
</li>
<li>
<p>args: arguments for the corresponding job, stored here to help describe the job</p>
</li>
<li>
<p>Its a hash of key-value pairs</p>
</li>
<li>
<p>The argument list could get big for a few jobs once we allow users to access domains that they don&#8217;t own</p>
</li>
<li>
<p><strong>TODO</strong>: Need to investigate the possibility of NOT storing all the arguments</p>
</li>
<li>
<p>child_jobs: array of job_status IDs corresponding to the jobs that are children of this job</p>
</li>
<li>
<p>The field will be populated as child jobs are created</p>
</li>
<li>
<p>parent_job: ID of the parent job in case this is a child job</p>
</li>
<li>
<p>state: [ "queued" | "executing" | "reverting" | "complete" ]</p>
</li>
<li>
<p>completion_state: [ "success" | "partial_success" | "failed" ]</p>
</li>
<li>
<p>Field is populated only once the job is complete</p>
</li>
<li>
<p>partial_success can happen when a user/domain operation fails on some applications and succeeds on others</p>
</li>
<li>
<p>failed state indicates that the job execution failed and there were no rollbacks required/performed</p>
</li>
<li>
<p>retry_count: The number of retries performed to execute the sub-op</p>
</li>
<li>
<p>This field will be applicable only when the state is "executing"</p>
</li>
<li>
<p>If the sub-op retry is successful and the execution proceeds, this fields will be reset to 0</p>
</li>
<li>
<p>rollback_retry_count: The number of retries performed to rollback/revert a failed sub-op</p>
</li>
<li>
<p>This field will be applicable only when the state is "reverting"</p>
</li>
<li>
<p>If the sub-op rollback retry is successful and the rollback proceeds, this field will be reset to 0</p>
</li>
<li>
<p>percentage_complete: valid values are [ null | 0.0-100.0 ]</p>
</li>
<li>
<p>This field will be null if completion percentage cannot be determined</p>
</li>
<li>
<p>This could be the ratio of number of sub-ops completed vs total sub-ops</p>
</li>
<li>
<p>As the job execution progresses, we could update the percentage_complete value, so that it is not recalculated for every API call</p>
</li>
<li>
<p>result: result_io object returned by the operation</p>
</li>
<li>
<p>In the regular case it will be present only once the state is "complete"</p>
</li>
<li>
<p>In case of failed retries and rollbacks, the result field will include the output of the failures</p>
</li>
<li>
<p>At a later point, we may start storing intermediate results from sub-op executions</p>
</li>
<li>
<p>In case of retries and eventual success, the result will include success messages from all pending ops (that have output messages)</p>
</li>
<li>
<p>In case of failures on retries leading to a rollback, the result will include last non-rollback error message</p>
</li>
<li>
<p>object_type: [ null | "application" | "domain" | "user" | "key" | "cartridge" ]</p>
</li>
<li>
<p>application_id: application ID</p>
</li>
<li>
<p>application_name: application name</p>
</li>
<li>
<p>domain_name: domain namespace</p>
</li>
<li>
<p>owner_login: user login of the owner of the application/domain/user object on which the job is being performed</p>
</li>
<li>
<p>creator_login: login of the user who created the job (made the user request)</p>
</li>
<li>
<p>Initially this field will be the same as the owner_login</p>
</li>
<li>
<p>Once we have multiple users accessing a domain, this could be different</p>
</li>
<li>
<p>object_url: URL for the resource that was created/modified for the client to query it</p>
</li>
<li>
<p>This field could be null in some cases, for instance when the request was to delete the application/domain</p>
</li>
</ul>
</div>
<div id="job-state-transition-examples" class="paragraph">
<p>Job State Transition Examples</p>
</div>
<div class="paragraph">
<p>The format is: state(completion_state)(retry_count)(rollback_retry_count)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Successful job completion</p>
</li>
<li>
<p>queued(nil)(0)(0) -&#8594; executing(nil)(0)(0) -&#8594; complete(success)</p>
</li>
<li>
<p>Successful job after 3 retries</p>
</li>
<li>
<p>queued(nil)(0)(0) -&#8594; executing(nil)(0)(0) -&#8594; executing(nil)(1)(0) -&#8594; queued(nil)(1)(0) -&#8594; executing(nil)(2)(0) -&#8594; queued(nil)(2)(0) -&#8594; executing(nil)(3)(0) -&#8594; complete(success)</p>
</li>
<li>
<p>Successful rollback of a failed job after 3 execution retries and 2 rollback retries</p>
</li>
<li>
<p>queued(nil)(0)(0) -&#8594; executing(nil)(0)(0) -&#8594; executing(nil)(1)(0) -&#8594; queued(nil)(1)(0) -&#8594; executing(nil)(2)(0) -&#8594; queued(nil)(2)(0) -&#8594; executing(nil)(3)(0) -&#8594; reverting(nil)(3)(0) -&#8594; queued(nil)(3)(0) -&#8594; reverting(nil)(3)(1) -&#8594; queued(nil)(3)(1) -&#8594; reverting(nil)(3)(2) -&#8594; complete(failed)</p>
</li>
<li>
<p>Failed rollback of a job after 3 execution attempts and 3 rollback attempts<br></p>
</li>
<li>
<p>queued(nil)(0)(0) -&#8594; executing(nil)(0)(0) -&#8594; executing(nil)(1)(0) -&#8594; queued(nil)(1)(0) -&#8594; executing(nil)(2)(0) -&#8594; queued(nil)(2)(0) -&#8594; executing(nil)(3)(0) -&#8594; reverting(nil)(3)(0) -&#8594; queued(nil)(3)(0) -&#8594; reverting(nil)(3)(1) -&#8594; queued(nil)(3)(1) -&#8594; reverting(nil)(3)(2) -&#8594; queued(nil)(3)(2) -&#8594; reverting(nil)(3)(3)</p>
</li>
</ul>
</div>
<div id="get-job-status" class="paragraph">
<p>Get Job Status</p>
</div>
<div class="paragraph">
<p>GET /jobs/&lt;job_id&gt;</p>
</div>
<div id="list-of-job-statuses-visible-to-the-user-will-require-pagination" class="paragraph">
<p>List of Job Statuses visible to the user (will require pagination)</p>
</div>
<div class="paragraph">
<p>GET /jobs</p>
</div>
<div id="list-of-job-statuses-for-a-user-will-require-pagination" class="paragraph">
<p>List of Job Statuses for a user (will require pagination)</p>
</div>
<div class="paragraph">
<p>GET /user/jobs</p>
</div>
<div id="list-of-job-statuses-for-a-domain-will-require-pagination" class="paragraph">
<p>List of Job Statuses for a domain (will require pagination)</p>
</div>
<div class="paragraph">
<p>GET /domains/&lt;dom_name&gt;/jobs</p>
</div>
<div id="list-of-job-statuses-for-an-app-will-require-pagination" class="paragraph">
<p>List of Job Statuses for an app (will require pagination)</p>
</div>
<div class="paragraph">
<p>GET /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/jobs<br>
GET /applications/&lt;app_id&gt;/jobs</p>
</div>
<div id="job-status-filtering-and-sorting" class="paragraph">
<p>Job status filtering and sorting</p>
</div>
<div class="paragraph">
<p>The REST API could allow options for: + Sort by time (eg: most recent first) + Filter by creator (eg: show only jobs I created) + Filter by status (eg: show queued and active jobs) + Filter by IDs + The UI will typically poll status for the jobs a user has launched + Having a way to query n jobs with a single request (upto a certain limit) would be helpful</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rest-api-changes"><a class="anchor" href="#rest-api-changes"></a>REST API Changes:</h4>
<div class="paragraph">
<p>The following APIs will return a 202(Accepted) with the body being the url of the status API for the job:<br>
PUT /domains/&lt;dom_name&gt;</p>
</div>
<div class="paragraph">
<p>POST /user/keys<br>
PUT /user/keys/&lt;key_name&gt;<br>
DELETE /user/keys/&lt;key_name&gt;</p>
</div>
<div class="paragraph">
<p>POST /domains/&lt;dom_name&gt;/applications<br>
DELETE /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;</p>
</div>
<div class="paragraph">
<p>POST /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/events</p>
</div>
<div class="paragraph">
<p>POST /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/cartridges<br>
DELETE /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/cartridges/&lt;cart_name&gt;</p>
</div>
<div class="paragraph">
<p>POST /domains/&lt;dom_name&gt;/applications/&lt;app_name&gt;/cartridges/&lt;cart_name&gt;/events</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backwards-compatibility"><a class="anchor" href="#backwards-compatibility"></a>Backwards Compatibility</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This change will require a new version of the REST API.</p>
</li>
<li>
<p>For requests made with the earlier REST API versions, the REST layer will loop through the job status and return the result back to the client</p>
</li>
<li>
<p>For newer API versions, the default behavior will be to return a HTTP 202 status with the job URL</p>
</li>
<li>
<p><strong>TBD</strong>: The new version of the REST API can potentially accept a parameter (something like <em>async=false</em>) from the user to determine whether to send the job URL with 202 status or poll the job status and return the result on completion</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="rationale"><a class="anchor" href="#rationale"></a>Rationale</h3>
<div class="sect3">
<h4 id="other-scheduling-technologies-considered"><a class="anchor" href="#other-scheduling-technologies-considered"></a>Other scheduling technologies considered:</h4>
<div class="ulist">
<ul>
<li>
<p>Resque</p>
</li>
<li>
<p>Pros: Best UI, Good code style, Solid job workers</p>
</li>
<li>
<p>Cons: Requires Redis (More heavyweight and complex to get HA)</p>
</li>
<li>
<p>delayed_job</p>
</li>
<li>
<p>Pros: Lighter weight, Mongo synergy</p>
</li>
<li>
<p>Cons: UI not as polished, Mongo version compatibility concerns</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="faqs"><a class="anchor" href="#faqs"></a>FAQs</h3>
<div id="who-maintains-what-queue-is-fed-by-which-brokers" class="paragraph">
<p>Who maintains what queue is fed by which brokers?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Broker configuration points to the IP/Port of the queue</p>
</li>
</ul>
</div>
<div id="what-exactly-is-pushed-into-the-queues" class="paragraph">
<p>What exactly is pushed into the queue(s)?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A "job" data structure which would primarily be a pointer to the application (application ID) and, if needed, some other details (not sure what else would be required)</p>
</li>
</ul>
</div>
<div id="what-are-the-benefits-of-having-a-separate-scheduler-for-each-broker" class="paragraph">
<p>What are the benefits of having a separate scheduler for each broker?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>automatic job load balancing</p>
</li>
<li>
<p>federated queues</p>
</li>
<li>
<p>less job contention between workers</p>
</li>
<li>
<p>reduced impact in case of scheduler process on a single broker failure/dying</p>
</li>
<li>
<p>avoiding network latency - both for adding and reserving a job</p>
</li>
</ul>
</div>
<div id="who-pops-from-the-queues" class="paragraph">
<p>Who pops from the queue(s)?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The workers (queue clients) reserve jobs from the queue</p>
</li>
<li>
<p>Whenever workers are spun, they are given the location of the queue</p>
</li>
</ul>
</div>
<div id="how-easy-is-it-to-add-more-machinescores-to-start-chewing-more-ops" class="paragraph">
<p>How easy is it to add more machines/cores to start chewing more ops?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new broker would need to be added</p>
</li>
<li>
<p>User requests coming to the new broker will be handled by the workers on it</p>
</li>
</ul>
</div>
<div id="what-if-a-broker-goes-down" class="paragraph">
<p>What if a broker goes down?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the broker rails app goes down, the scheduler process is still running, the jobs are intact, and the worker processes can continue</p>
</li>
<li>
<p>If the broker machine along with the scheduler crashes, then upon restart, the jobs persisted to disk are reloaded by the scheduler and can be picked up by the workers</p>
</li>
</ul>
</div>
<div id="what-if-ops-want-to-remove-a-broker" class="paragraph">
<p>What if ops want to remove a broker?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If Ops wants to shut down a broker, similar to ensuring that the broker processes are not working, the scheduler workers will need to be monitored to make sure that workers are done and also that the queue is empty</p>
</li>
<li>
<p>Shutting down a broker would also require that the broker not get any new user requests from the controllers - a way of "deactivating" it or taking it out of the "load balancer" or whatever we use to distribute user requests to our brokers</p>
</li>
</ul>
</div>
</div></div>
<div id="footer">
<div id="footer-text">
<br>
Last updated 2013-09-18 16:42:53 UTC
</div>
<!-- Google Analytics -->
<script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40375612-1']);
  _gaq.push(['_setDomainName', 'openshift.github.io']);
  _gaq.push(['_trackPageview']);
  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  
  $(document).ready(function() {
    _gaq.push(function() {
      $('a:not([href^="http"])').on("click", function(e) {
        e.preventDefault();
        var link = $(this).attr("href");
        _gaq.push(["_trackEvent", "Internal Links", "click", link]);
        setTimeout('document.location = "' + link + '"', 300);
      });
      $('a[href^="http"]').on("click", function(e) {
        e.preventDefault();
        var link = $(this).attr("href");
        _gaq.push(["_trackEvent", "Outbound Links", "click", link]);
        setTimeout('document.location = "' + link + '"', 300);
      });
    });
  });
</script>
<!-- Google Code for Remarketing -->
<script>
  var google_conversion_id = 1007064360;
  var google_conversion_label = "7jfmCMC5ugQQqKqa4AM";
  var google_custom_params = window.google_tag_params;
  var google_remarketing_only = true;
</script>
<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script>
<noscript>
<div style="display: inline;">
<img alt="" height="1" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1007064360/?value=0&amp;label=7jfmCMC5ugQQqKqa4AM&amp;guid=ON&amp;script=0" style="border-style: none;" width="1">
</div>
</noscript>
</div>
</body>
</html>